

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sw_openmm &mdash; Polymer Simulator 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Polymer Simulator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../packagecontents.html">Package Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sw_openmm.html">Module Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sw_build_systems.html">sw_build_systems Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Polymer Simulator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">sw_openmm</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sw_openmm</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Wed Mar 13 13:50:12 2024</span>

<span class="sd">@author: danie</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">parmed</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">openmm</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">openmm.app</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">openmm.unit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">openmm.app.topology</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1">#from openmmml import MLPotential</span>

<span class="kn">from</span> <span class="nn">openbabel</span> <span class="kn">import</span> <span class="n">openbabel</span><span class="p">,</span> <span class="n">pybel</span>


<div class="viewcode-block" id="get_rmsd">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.get_rmsd">[docs]</a>
<span class="k">def</span> <span class="nf">get_rmsd</span><span class="p">(</span><span class="n">pdb_ref</span><span class="p">,</span> <span class="n">pdb_prb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Root Mean Square Deviation (RMSD) between two molecular structures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pdb_ref : str</span>
<span class="sd">        The path to the PDB file of the reference molecule.</span>
<span class="sd">    pdb_prb : str</span>
<span class="sd">        The path to the PDB file of the probe molecule.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The RMSD between the reference and probe molecules after alignment.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
    <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdMolAlign</span>

    <span class="c1"># Load your molecules</span>
    <span class="n">prbMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromPDBFile</span><span class="p">(</span><span class="n">pdb_prb</span><span class="p">)</span>
    <span class="n">refMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromPDBFile</span><span class="p">(</span><span class="n">pdb_ref</span><span class="p">)</span>

    <span class="c1"># Align the probe molecule to the reference molecule</span>
    <span class="n">rmsd</span> <span class="o">=</span> <span class="n">rdMolAlign</span><span class="o">.</span><span class="n">AlignMol</span><span class="p">(</span><span class="n">prbMol</span><span class="p">,</span> <span class="n">refMol</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rmsd</span></div>




<div class="viewcode-block" id="TopologyML">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML">[docs]</a>
<span class="k">class</span> <span class="nc">TopologyML</span><span class="p">(</span><span class="n">Topology</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TopologyML holds the topology information needed by ANI force filed.</span>
<span class="sd">    There are errors with OpenMM-ML importing pdb files built using packmol due to the use of</span>
<span class="sd">    non standar residues.</span>

<span class="sd">    Parmed is used to load the pdb.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_pdb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self : TopologyML</span>
<span class="sd">            The new object created</span>
<span class="sd">        input_pdb : string</span>
<span class="sd">            Pdb file to load with parmed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reading pdb with parmed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">read_pdb</span><span class="p">(</span><span class="n">input_pdb</span><span class="p">)</span>
        <span class="c1"># Creating a PSF file with parmed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">write_psf</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">input_pdb</span><span class="si">}</span><span class="s1">.psf&#39;</span><span class="p">)</span>
        <span class="c1"># Createing OpenMM topology object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_topo</span> <span class="o">=</span> <span class="n">Topology</span><span class="p">()</span>
        <span class="c1"># Transforming to pandas dataframe the pdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb_pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

<div class="viewcode-block" id="TopologyML.get_pm_chains">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.get_pm_chains">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pm_chains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets PDB chains from Parmed</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        _chains : list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb_pd</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>  
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span></div>

    
<div class="viewcode-block" id="TopologyML.get_chain_obj">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.get_chain_obj">[docs]</a>
    <span class="k">def</span> <span class="nf">get_chain_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the OpenMM chain object associated to the PDB chain readed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : string</span>
<span class="sd">            Chain identificator string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_topo</span><span class="o">.</span><span class="n">chains</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_c</span></div>


<div class="viewcode-block" id="TopologyML.create_chains">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.create_chains">[docs]</a>
    <span class="k">def</span> <span class="nf">create_chains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chains</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates OpenMM chains</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chains : list</span>
<span class="sd">            Chains to be created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_c</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_topo</span><span class="o">.</span><span class="n">addChain</span><span class="p">(</span><span class="n">_c</span><span class="p">)</span></div>


<div class="viewcode-block" id="TopologyML.get_pm_residues">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.get_pm_residues">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pm_residues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets residue list using parmed</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _residues : list</span>
<span class="sd">            Residues list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_residues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb_pd</span><span class="p">[[</span><span class="s1">&#39;resname&#39;</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span><span class="s1">&#39;resnum&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;resname&#39;</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;resnum&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residues</span></div>


<div class="viewcode-block" id="TopologyML.get_res_obj">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.get_res_obj">[docs]</a>
    <span class="k">def</span> <span class="nf">get_res_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">res_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the OpenMM residue object associated to the PDB residue</span>
<span class="sd">        created before.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chain : string</span>
<span class="sd">            Chain name in PDB file</span>
<span class="sd">        res_id : string</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._r : OpenMM residue object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_chain_obj</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">residues</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_id</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span></div>


        
<div class="viewcode-block" id="TopologyML.create_residue">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.create_residue">[docs]</a>
    <span class="k">def</span> <span class="nf">create_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">resnum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create residue on Topology object given a set of properties.</span>
<span class="sd">        It is necessary to use the method `get_chain_name` to transform</span>
<span class="sd">        the chain_name to its associatd chain object created previously. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        resname : string</span>
<span class="sd">            Residue name given by parmed.</span>
<span class="sd">        resnum : string</span>
<span class="sd">            Residue number given by parmed.</span>
<span class="sd">        chain_name : string</span>
<span class="sd">            Chain name given by parmed</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _residues : list</span>
<span class="sd">            Residues list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_chain_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_chain_obj</span><span class="p">(</span><span class="n">chain_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_topo</span><span class="o">.</span><span class="n">addResidue</span><span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">_chain_obj</span><span class="p">,</span> <span class="n">resnum</span><span class="p">)</span></div>


<div class="viewcode-block" id="TopologyML.create_residues">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.create_residues">[docs]</a>
    <span class="k">def</span> <span class="nf">create_residues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residues</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_topo</span><span class="o">.</span><span class="n">chains</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_r</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
                <span class="n">_resname</span> <span class="o">=</span> <span class="n">_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_chain_name</span> <span class="o">=</span> <span class="n">_r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">_resnum</span> <span class="o">=</span> <span class="n">_r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">_c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">_chain_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_residue</span><span class="p">(</span><span class="n">_resname</span><span class="p">,</span> <span class="n">_chain_name</span><span class="p">,</span> <span class="n">_resnum</span><span class="p">)</span></div>


<div class="viewcode-block" id="TopologyML.get_pm_atoms">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.get_pm_atoms">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pm_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets lists of atoms from parmed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        atoms : list</span>
<span class="sd">            Atoms list of lists [[number, name, chain, resnum], ...] </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self._atoms = self.pdb.atoms</span>
        <span class="c1">#return self._atoms</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span></div>

        
<div class="viewcode-block" id="TopologyML.get_pm_num_atoms">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.get_pm_num_atoms">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pm_num_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate and return the number of atoms in the `pdb` attribute.</span>

<span class="sd">        The function iterates through the `pdb` attribute (assumed to be an iterable </span>
<span class="sd">        containing atomic data) and counts the number of elements (atoms).</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of atoms in the `pdb` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span></div>


    
<div class="viewcode-block" id="TopologyML.create_topo">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.TopologyML.create_topo">[docs]</a>
    <span class="k">def</span> <span class="nf">create_topo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;This method creates an OpenMM Topology object. The pdb file is parsed</span>
<span class="sd">        and translated to an OpenMM object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Reading PDB chains with parmed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pm_chains</span><span class="p">()</span>
        <span class="c1"># Reading PDB residues with parmed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pm_residues</span><span class="p">()</span>
        <span class="c1"># Reading PDB atoms with parmed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pm_atoms</span><span class="p">()</span>
        <span class="c1"># Let&#39;s create</span>
            <span class="c1"># Chains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_chains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chains</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_topo</span><span class="o">.</span><span class="n">getNumChains</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_chains</span><span class="si">}</span><span class="s1"> chains&#39;</span><span class="p">)</span>
            <span class="c1"># Residues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_residues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_residues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_topo</span><span class="o">.</span><span class="n">getNumResidues</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_residues</span><span class="si">}</span><span class="s1"> residues&#39;</span><span class="p">)</span>
        <span class="c1"># Atoms</span>
        <span class="c1"># The chains and residues have been created in topology. Let&#39;s try with atoms.</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_atom</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">Element</span><span class="o">.</span><span class="n">getBySymbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span>
            <span class="n">res_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">number</span>
            <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atom</span><span class="o">.</span><span class="n">number</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span>
            <span class="n">res_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_res_obj</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">res_number</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_topo</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">res_obj</span><span class="p">)</span>
        <span class="c1"># Returning topology object</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_topo</span></div>
</div>

    
<div class="viewcode-block" id="PositionsML">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.PositionsML">[docs]</a>
<span class="k">class</span> <span class="nc">PositionsML</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_pdb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract the position from the pdb file. OpenMMM works in nanometer</span>
<span class="sd">        units, so, every coordinate system is converted to nanometer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_pdb : string</span>
<span class="sd">            Pdb file to load with parmed.</span>
<span class="sd">        </span>
<span class="sd">        Returns array</span>
<span class="sd">        -------</span>
<span class="sd">        coords: numpyt array with coordinates</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reading pdb with parmed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">read_pdb</span><span class="p">(</span><span class="n">input_pdb</span><span class="p">)</span>
        <span class="c1"># Createing OpenMM positions object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">/</span><span class="n">nanometer</span><span class="p">)</span>
        <span class="c1"># The coordinates are translated to the origin.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">*</span> <span class="n">nanometer</span>
    
<div class="viewcode-block" id="PositionsML.get_pbc">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.PositionsML.get_pbc">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pbc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the PBC vectors.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">/</span><span class="n">nanometer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbc_coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_coord</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_coord</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbc_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbc_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">]</span></div>
</div>


<div class="viewcode-block" id="DcdWriter">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.DcdWriter">[docs]</a>
<span class="k">class</span> <span class="nc">DcdWriter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to handle writing DCD (Dynamics Coordinate Data) files for molecular simulations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        dcdReporter (app.DCDReporter): An instance of DCDReporter to write the DCD file with specified parameters.</span>

<span class="sd">    Methods:</span>
<span class="sd">        __init__(prefix: str, freq: int):</span>
<span class="sd">            Initializes the DcdWriter with the given prefix and frequency for writing frames.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a DcdWriter instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (str): The prefix for the output DCD file name.</span>
<span class="sd">            freq (int): The frequency (in steps) at which frames are written to the DCD file.</span>

<span class="sd">        The output file will be named `{prefix}.dcd`. The DCDReporter enforces the periodic box</span>
<span class="sd">        constraints for the simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcdReporter</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">DCDReporter</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">.dcd&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="DataWriter">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.DataWriter">[docs]</a>
<span class="k">class</span> <span class="nc">DataWriter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to handle writing simulation state data to a text file.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        stateDataReporter (app.StateDataReporter): An instance of StateDataReporter to log simulation data.</span>

<span class="sd">    Methods:</span>
<span class="sd">        __init__(prefix: str, freq: int, steps: int):</span>
<span class="sd">            Initializes the DataWriter with the given prefix, frequency, and total number of steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a DataWriter instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (str): The prefix for the output text file name.</span>
<span class="sd">            freq (int): The frequency (in steps) at which data is written to the text file.</span>
<span class="sd">            steps (int): The total number of simulation steps.</span>

<span class="sd">        The output file will be named `{prefix}.txt`. The StateDataReporter logs various</span>
<span class="sd">        simulation parameters, including step count, time, speed, progress, elapsed time, </span>
<span class="sd">        total energy, kinetic energy, potential energy, temperature, volume, and density.</span>
<span class="sd">        The data is separated by commas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateDataReporter</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">StateDataReporter</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">totalSteps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">elapsedTime</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">totalEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kineticEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">potentialEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span>
        <span class="p">)</span></div>




<div class="viewcode-block" id="BuildSimulation">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation">[docs]</a>
<span class="k">class</span> <span class="nc">BuildSimulation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for building and managing molecular simulations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pressure (float): The default pressure for simulations, in atmospheres.</span>
<span class="sd">        temp (float): The default temperature for simulations, in Kelvin.</span>
<span class="sd">        timestep (float): The default timestep for simulations, in femtoseconds.</span>
<span class="sd">        friction_coeff (float): The default friction coefficient for Langevin dynamics simulations, in units of 1/picoseconds.</span>
<span class="sd">        total_steps (int): The default total number of steps for simulations.</span>
<span class="sd">        reporter_freq (int): The default frequency for reporting data during simulations.</span>
<span class="sd">        anneal_parameters (list): Parameters for simulated annealing, including start temp, max temp, cycles, holding steps, </span>
<span class="sd">            and steps at each temperature.</span>

<span class="sd">    Methods:</span>
<span class="sd">        type_of_simulation(self): Determine the type of simulation.</span>
<span class="sd">        minimize_energy(self): Perform energy minimization of the system.</span>
<span class="sd">        minimize_energy_help(cls): Display help information for the minimize_energy method.</span>
<span class="sd">        anneal(self, simulation, start_temp=None, max_temp=None, cycles=None, holding_steps=None, steps_at_temp=None): </span>
<span class="sd">            Perform simulated annealing on the provided simulation system.</span>
<span class="sd">        anneal_help(cls): Display help information for the anneal method.</span>
<span class="sd">        equilibrate(self, simulation, total_steps=None, temp=None, pressure=None): Equilibrate the provided simulation.</span>
<span class="sd">        equilibrate_help(cls): Display help information for the equilibrate method.</span>
<span class="sd">        production_run(self, simulation, total_steps=None, temp=None): Perform a production run simulation.</span>
<span class="sd">        production_run_help(cls): Display help information for the production_run method.</span>
<span class="sd">        __repr__(self): Representation of the simulation parameters.</span>
<span class="sd">        __str__(self): String representation of the simulation object.</span>
<span class="sd">        set_temperature(cls, temp): Set the temperature for simulations.</span>
<span class="sd">        set_pressure(cls, pressure): Set the pressure for simulations.</span>
<span class="sd">        set_timestep(cls, timestep): Set the timestep for simulations.</span>
<span class="sd">        set_friction_coeff(cls, friction_coeff): Set the friction coefficient for simulations.</span>
<span class="sd">        set_total_steps(cls, total_steps): Set the total number of steps for simulations.</span>
<span class="sd">        set_reporter_freq(cls, reporter_freq): Set the reporter frequency for simulations.</span>
<span class="sd">        set_anneal_parameters(cls, new_anneal_parameters): Set annealing parameters.</span>
<span class="sd">        graph_state_data(data_file): Graph the state data from a data file.</span>

<span class="sd">    Notes:</span>
<span class="sd">        This class provides a comprehensive interface for setting up, running, and managing molecular simulations.</span>
<span class="sd">        It includes methods for energy minimization, simulated annealing, equilibration, production runs, and visualization of data.</span>

<span class="sd">    Child Classes (this class is used through these child classes, do not try to call BuildSimulaiton on its own unless you plan to only utilise static methods):</span>
<span class="sd">        - ANISimulation: A class representing ANI (Atomic Neural Network Interaction) molecular dynamics simulations.</span>
<span class="sd">        - AmberSimulation: A class representing AMBER molecular dynamics simulations.</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">savepdb_traj</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">timestep</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">friction_coeff</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">total_steps</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">reporter_freq</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">nonbondedcutoff</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
    <span class="c1"># Start temp, max temp, cycles, holding_steps, steps at each temp</span>
    <span class="n">anneal_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">minimized_only</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># This will change to True/False and will determine how periodic box vectors are set</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a BuildSimulation object with specified directories and filename </span>

<span class="sd">        Args:</span>
<span class="sd">            directories (str): The directories where simulation files are stored.</span>
<span class="sd">            filename (str): The name of the simulation file.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            filename (str): The name of the simulation file.</span>
<span class="sd">            directories (str): The directories where simulation files are stored.</span>
<span class="sd">            output_dir (str): The directory for simulation output.</span>
<span class="sd">            log_info (dict): Information log for different stages of the simulation.</span>
<span class="sd">            log_csv (str): The path to the CSV log file.</span>

<span class="sd">        Notes:</span>
<span class="sd">            If the output directory does not exist, it will be created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Minimization&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Temperature&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Time taken&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                            <span class="s1">&#39;Annealing_NPT&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Time taken&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Simulation time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Start temp&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Target temp&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Cycles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Steps at plateaus&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Steps at incremental temps&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Timestep&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                            <span class="s1">&#39;basic_NPT&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Time taken&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Simulation time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Temperature&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Pressure&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Timestep&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                            <span class="s1">&#39;basic_NVT&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Time taken&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Simulation time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Temperature&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Timestep&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                        <span class="s1">&#39;Thermal Ramp&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Time taken&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Simulation time&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Start temp&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Target temp&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Quench Rate&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Steps at incremental temps&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Timestep&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Ensemble&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Method&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="s2">&quot;_log.csv&quot;</span><span class="p">))</span>
                             
<div class="viewcode-block" id="BuildSimulation.type_of_simulation">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.type_of_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the type of simulation.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: A string indicating the type of simulation, either &quot;AMB&quot; for AmberSimulation or &quot;ANI&quot; for ANISimulation.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method inspects the type of the current object to determine the type of simulation.</span>
<span class="sd">            If the object is an instance of AmberSimulation, it returns &quot;AMB&quot;.</span>
<span class="sd">            If the object is an instance of ANISimulation, it returns &quot;ANI&quot;.</span>
<span class="sd">            If the object is neither, it returns a message prompting the user to specify the type of simulation by calling </span>
<span class="sd">            either AmberSimulation or ANISimulation classes.</span>
<span class="sd">            </span>
<span class="sd">            This function should never need to be called as we can we can the type of our simulation object with: repr(simulation_object)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">AmberSimulation</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;AMB&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ANISimulation</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;ANI&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Please specify type of simulation by calling &lt;AmberSimulation&gt; OR &lt;ANISimulation&gt; classes&quot;</span></div>

    
<div class="viewcode-block" id="BuildSimulation.minimize_energy">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.minimize_energy">[docs]</a>
    <span class="k">def</span> <span class="nf">minimize_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to perform energy minimization of the system using Langevin dynamics.</span>
<span class="sd">        </span>
<span class="sd">        USAGE:</span>
<span class="sd">            minimized_sim = simulation_object.minimize_energy()</span>

<span class="sd">        Returns:</span>
<span class="sd">            minimized_simulation_object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">LangevinIntegrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">*</span><span class="n">kelvin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction_coeff</span><span class="o">/</span><span class="n">picoseconds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="o">*</span><span class="n">femtoseconds</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;AMB&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amb_coordinates</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ANI&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">PLatform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_coordinates</span><span class="p">)</span>
        
        <span class="n">simulation</span><span class="o">.</span><span class="n">minimizeEnergy</span><span class="p">()</span>


        <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">min_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;min_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_pdbname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(),</span> <span class="n">output</span><span class="p">)</span>
        
        <span class="n">min_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  
        <span class="n">time_taken</span> <span class="o">=</span> <span class="n">min_end_time</span> <span class="o">-</span> <span class="n">min_start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Minimization&#39;</span><span class="p">][</span><span class="s1">&#39;Time taken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_taken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Minimization&#39;</span><span class="p">][</span><span class="s1">&#39;Temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span>
        <span class="k">return</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span></div>

     
<div class="viewcode-block" id="BuildSimulation.minimize_energy_help">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.minimize_energy_help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">minimize_energy_help</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display help information for the minimize_energy method.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">minimize_energy</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>    </div>

     
<div class="viewcode-block" id="BuildSimulation.anneal_NVT">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.anneal_NVT">[docs]</a>
    <span class="k">def</span> <span class="nf">anneal_NVT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">start_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holding_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">steps_at_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to perform simulated annealing on the provided simulation system.</span>
<span class="sd">        </span>
<span class="sd">        USAGE: </span>
<span class="sd">            annealed_sim = sim.anneal(simulation, start_temp, max_temp, cycles, holding_steps, steps_at_temp)            </span>
<span class="sd">        </span>
<span class="sd">        Recommended USAGE:</span>
<span class="sd">            annealed_sim = sim.anneal(simulation)</span>
<span class="sd">            </span>
<span class="sd">            where annealing parameters are set with the following function:</span>
<span class="sd">                </span>
<span class="sd">            simulation_object.set_anneal_parameters([start_temp, max_temp, cycles, holding_steps, steps_at_each_temp])</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            simulation (app.Simulation): The simulation object to perform annealing on.</span>
<span class="sd">            </span>
<span class="sd">            start_temp (float, optional): The starting temperature for annealing in Kelvin. Defaults to None, </span>
<span class="sd">                in which case the value is fetched from self.anneal_parameters[0].</span>
<span class="sd">                </span>
<span class="sd">            max_temp (float, optional): The maximum temperature for annealing in Kelvin. Defaults to None, </span>
<span class="sd">                in which case the value is fetched from self.anneal_parameters[1].</span>
<span class="sd">                </span>
<span class="sd">            cycles (int, optional): The number of annealing cycles to perform. Defaults to None, </span>
<span class="sd">                in which case the value is fetched from self.anneal_parameters[2].</span>
<span class="sd">                </span>
<span class="sd">            holding_steps (int, optional): The number of steps to hold the system at each temperature. </span>
<span class="sd">                Defaults to None, in which case the value is fetched from self.anneal_parameters[3].</span>
<span class="sd">                </span>
<span class="sd">            steps_at_temp (int, optional): The number of steps to perform at each temperature. </span>
<span class="sd">                Defaults to None, in which case the value is fetched from self.anneal_parameters[4].</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing the simulation object after annealing and the filename of the data file generated.</span>
<span class="sd">                in the following format:</span>
<span class="sd">        </span>
<span class="sd">            (simulation_object, path_to_data_file)</span>
<span class="sd">                    </span>
<span class="sd">        Notes:</span>
<span class="sd">            This method performs simulated annealing on the provided simulation object. It initializes the system with the </span>
<span class="sd">        provided initial conditions and runs annealing cycles adjusting the temperature according to the specified parameters.</span>
<span class="sd">        The system&#39;s state is updated throughout the annealing process, and reporters are set up to record trajectory and </span>
<span class="sd">        simulation data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anneal_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">start_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anneal_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">max_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anneal_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cycles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cycles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anneal_parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">holding_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">holding_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anneal_parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">steps_at_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">steps_at_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anneal_parameters</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
         
        <span class="c1"># Extract positional info</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Define state object </span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">()</span> <span class="c1"># Obtain positions of the particles from previous step</span>
        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span> <span class="c1"># Obtain periodc box vectors of the previous step</span>
        
        <span class="c1"># Set up integrator</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">LangevinIntegrator</span><span class="p">(</span><span class="n">start_temp</span><span class="o">*</span><span class="n">kelvin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction_coeff</span><span class="o">/</span><span class="n">picoseconds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="o">*</span><span class="n">femtoseconds</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;AMB&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ANI&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">PLatform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>

        <span class="c1"># Update the xyz of each atom</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        
        <span class="c1"># Total up all steps of the equilibration so the rpeorters record properly</span>
        <span class="n">total_steps</span> <span class="o">=</span> <span class="p">(((</span><span class="n">max_temp</span><span class="o">-</span><span class="n">start_temp</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="n">holding_steps</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cycles</span>
        
        <span class="c1"># Set up reporters</span>
        <span class="c1"># PDB trajectory - this is slighlty redundant with the addition of the DCD trajectory, but it is still useful for </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savepdb_traj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_anneal_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span> <span class="p">))</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">PDBReporter</span><span class="p">(</span><span class="n">output_pdbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">))</span>
        
        <span class="c1"># DCD trajectory</span>
        <span class="c1">#output_dcdname = os.path.join(directories.systems_dir, self.filename, (self.filename + &quot;_anneal&quot;))</span>
        <span class="n">output_dcdname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_anneal_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="n">dcdWriter</span> <span class="o">=</span> <span class="n">DcdWriter</span><span class="p">(</span><span class="n">output_dcdname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcdWriter</span><span class="o">.</span><span class="n">dcdReporter</span><span class="p">)</span>
    
        <span class="c1"># Datawriter - This is a more complete data writer than previously used, the file generated is a comma delimited text file</span>
        <span class="c1">#output_dataname = os.path.join(directories.systems_dir, self.filename, (self.filename + &quot;_anneal_data&quot;))</span>
        <span class="n">output_dataname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_anneal_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="n">dataWriter</span> <span class="o">=</span> <span class="n">DataWriter</span><span class="p">(</span><span class="n">output_dataname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataWriter</span><span class="o">.</span><span class="n">stateDataReporter</span><span class="p">)</span>
        
        <span class="n">increments</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_temp</span><span class="o">-</span><span class="n">start_temp</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cycles</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">increments</span><span class="p">):</span>
                <span class="n">integrator</span><span class="o">.</span><span class="n">setTemperature</span><span class="p">(</span><span class="n">start_temp</span><span class="o">+</span><span class="n">j</span><span class="p">)</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">steps_at_temp</span><span class="p">)</span>
            
            <span class="n">integrator</span><span class="o">.</span><span class="n">setTemperature</span><span class="p">(</span><span class="n">max_temp</span><span class="p">)</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">holding_steps</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">increments</span><span class="p">):</span>
                <span class="n">integrator</span><span class="o">.</span><span class="n">setTemperature</span><span class="p">(</span><span class="n">max_temp</span><span class="o">-</span><span class="n">j</span><span class="p">)</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">steps_at_temp</span><span class="p">)</span>
                
            <span class="n">integrator</span><span class="o">.</span><span class="n">setTemperature</span><span class="p">(</span><span class="n">start_temp</span><span class="p">)</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">holding_steps</span><span class="p">)</span>

        <span class="n">anneal_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  
        <span class="n">time_taken</span> <span class="o">=</span> <span class="n">anneal_end_time</span> <span class="o">-</span> <span class="n">anneal_start_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Annealing&#39;</span><span class="p">][</span><span class="s1">&#39;Time taken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_taken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Annealing&#39;</span><span class="p">][</span><span class="s1">&#39;Simulation time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_steps</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Annealing&#39;</span><span class="p">][</span><span class="s1">&#39;Start temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Annealing&#39;</span><span class="p">][</span><span class="s1">&#39;Target temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Annealing&#39;</span><span class="p">][</span><span class="s1">&#39;Cycles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cycles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Annealing&#39;</span><span class="p">][</span><span class="s1">&#39;Steps at plateaus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">holding_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Annealing&#39;</span><span class="p">][</span><span class="s1">&#39;Steps at incremental temps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps_at_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Annealing&#39;</span><span class="p">][</span><span class="s1">&#39;Timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="c1"># Write the final structure to pdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;final_anneal_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_pdbname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(),</span> <span class="n">output</span><span class="p">)</span>
        
        <span class="k">return</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="p">(</span><span class="n">output_dataname</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="BuildSimulation.anneal_help">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.anneal_help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">anneal_help</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display help information for the anneal method.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">anneal</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>    </div>

<div class="viewcode-block" id="BuildSimulation.basic_NPT">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.basic_NPT">[docs]</a>
    <span class="k">def</span> <span class="nf">basic_NPT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">total_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to equilibrate the provided simulation to reach a specified temperature and pressure.</span>
<span class="sd">        </span>
<span class="sd">        USAGE: </span>
<span class="sd">            equilibrated_sim = sim.anneal(simulation, total_steps, temp, pressure)            </span>
<span class="sd">        </span>
<span class="sd">        Recommended USAGE:</span>
<span class="sd">            equilibrated_sim = sim.anneal(simulation)</span>
<span class="sd">            </span>
<span class="sd">            where annealing parameters are set with the following functions:</span>
<span class="sd">                </span>
<span class="sd">            simulation_object.set_temperature(temperature)</span>
<span class="sd">            simulation_object.set_pressure(pressure)</span>
<span class="sd">            simulation_object.set_total_steps(total_steps)</span>
<span class="sd">            </span>
<span class="sd">        Args:</span>
<span class="sd">            simulation (app.Simulation): The simulation object to equilibrate.</span>
<span class="sd">            </span>
<span class="sd">            total_steps (int, optional): The total number of steps to run for equilibration. Defaults to None, </span>
<span class="sd">                in which case the value is fetched from self.total_steps.</span>
<span class="sd">                </span>
<span class="sd">            temp (float, optional): The target temperature for equilibration in Kelvin. Defaults to None, </span>
<span class="sd">                in which case the value is fetched from self.temp.</span>
<span class="sd">                </span>
<span class="sd">            pressure (float, optional): The target pressure for equilibration in atmospheres. Defaults to None, </span>
<span class="sd">                in which case the value is fetched from self.pressure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing the simulation object after equilibration and the filename of the data file generated</span>
<span class="sd">                in the following format:</span>
<span class="sd">                    </span>
<span class="sd">            (simulation_object, path_to_data_file)</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method performs equilibration on the provided simulation object to reach the specified temperature and pressure.</span>
<span class="sd">            It initializes the system with the provided initial conditions and runs the simulation for the specified number </span>
<span class="sd">            of steps. The system&#39;s state is updated throughout the equilibration process, and reporters are set up to record </span>
<span class="sd">            trajectory and simulation data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">equili_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">total_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span>
        <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span>
        <span class="k">if</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span>
            
        <span class="c1"># Extract positional info</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Define state object </span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">()</span> <span class="c1"># Obtain positions of the particles from previous step</span>
        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span>
        
        <span class="c1"># Set up integrator and barostat</span>
        <span class="n">barostat</span> <span class="o">=</span> <span class="n">MonteCarloBarostat</span><span class="p">((</span><span class="n">pressure</span><span class="o">*</span><span class="n">atmosphere</span><span class="p">),</span> <span class="p">(</span><span class="n">temp</span><span class="o">*</span><span class="n">kelvin</span><span class="p">))</span> <span class="c1"># Define barostat (pressure, temp)</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">LangevinIntegrator</span><span class="p">(</span><span class="n">temp</span><span class="o">*</span><span class="n">kelvin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction_coeff</span><span class="o">/</span><span class="n">picoseconds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="o">*</span><span class="n">femtoseconds</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;AMB&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">barostat</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ANI&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">barostat</span><span class="p">)</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">PLatform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>

        <span class="c1"># We set the box vectors with the output from the the previous simulation</span>
        <span class="c1">#if self.minimized_only == False:       </span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
        
        <span class="c1"># Update positional info</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
             
        <span class="c1"># Set initial velocities</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setVelocitiesToTemperature</span><span class="p">(</span><span class="n">temp</span><span class="o">*</span><span class="n">kelvin</span><span class="p">)</span>
        
        <span class="c1"># Set up reporters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savepdb_traj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span>  <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_atm_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">PDBReporter</span><span class="p">(</span><span class="n">output_pdbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">))</span>
    
        <span class="c1"># DCD trajectory</span>
        <span class="c1">#output_dcdname = os.path.join(directories.systems_dir, self.filename, (self.filename +  &quot;_&quot; + str(pressure) + &quot;_atm_traj.dcd&quot;))</span>
        <span class="n">output_dcdname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span>  <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_atm_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="n">dcdWriter</span> <span class="o">=</span> <span class="n">DcdWriter</span><span class="p">(</span><span class="n">output_dcdname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcdWriter</span><span class="o">.</span><span class="n">dcdReporter</span><span class="p">)</span>
    
        <span class="c1"># Datawriter - This is a more complete data writer than previously used, the file generated is a comma delimited text file</span>
        <span class="c1">#output_dataname = os.path.join(directories.systems_dir, self.filename, (self.filename +  &quot;_&quot; + str(pressure) + &quot;_atm_data&quot;))</span>
        <span class="n">output_dataname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span>  <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_atm_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="n">dataWriter</span> <span class="o">=</span> <span class="n">DataWriter</span><span class="p">(</span><span class="n">output_dataname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataWriter</span><span class="o">.</span><span class="n">stateDataReporter</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">total_steps</span><span class="p">)</span>       

        <span class="n">equili_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  
        <span class="n">time_taken</span> <span class="o">=</span> <span class="n">equili_end_time</span> <span class="o">-</span> <span class="n">equili_start_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Basic_NPT&#39;</span><span class="p">][</span><span class="s1">&#39;Time taken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_taken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Basic_NPT&#39;</span><span class="p">][</span><span class="s1">&#39;Simulation time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Basic_NPT&#39;</span><span class="p">][</span><span class="s1">&#39;Temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Basic_NPT&#39;</span><span class="p">][</span><span class="s1">&#39;Pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Basic_NPT&#39;</span><span class="p">][</span><span class="s1">&#39;Timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="c1"># Write the final structure to pdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;final_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_atm.pdb&quot;</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_pdbname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(),</span> <span class="n">output</span><span class="p">)</span>
            
        <span class="k">return</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="p">(</span><span class="n">output_dataname</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="BuildSimulation.equilibrate_help">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.equilibrate_help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">equilibrate_help</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display help information for the equilibrate method.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">equilibrate</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span> </div>

        
<div class="viewcode-block" id="BuildSimulation.basic_NVT">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.basic_NVT">[docs]</a>
    <span class="k">def</span> <span class="nf">basic_NVT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">total_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to perform a production run simulation with the provided parameters.</span>
<span class="sd">        </span>
<span class="sd">        USAGE: </span>
<span class="sd">            production_run_sim = sim.anneal(simulation, total_steps, temp)            </span>
<span class="sd">        </span>
<span class="sd">        Recommended USAGE:</span>
<span class="sd">            production_run_sim = sim.anneal(simulation)</span>
<span class="sd">            </span>
<span class="sd">            where annealing parameters are set with the following functions:</span>
<span class="sd">                </span>
<span class="sd">            simulation_object.set_temperature(temperature)</span>
<span class="sd">            simulation_object.set_total_steps(total_steps)</span>
<span class="sd">            </span>
<span class="sd">        Args:</span>
<span class="sd">            simulation (app.Simulation): The simulation object to run the production simulation on.</span>
<span class="sd">            </span>
<span class="sd">            total_steps (int, optional): The total number of steps to run for the production simulation. </span>
<span class="sd">                Defaults to None, in which case the value is fetched from self.total_steps.</span>
<span class="sd">            </span>
<span class="sd">            temp (float, optional): The temperature for the production simulation in Kelvin. </span>
<span class="sd">                Defaults to None, in which case the value is fetched from self.temp.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing the simulation object after the production run and the filename of the data file generated.</span>
<span class="sd">                in the following format:</span>
<span class="sd">                </span>
<span class="sd">            (simulation_object, path_to_data_file)</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method performs a production run simulation with the provided simulation object and parameters.</span>
<span class="sd">            It initializes the system with the provided initial conditions and runs the simulation for the specified </span>
<span class="sd">            number of steps. The system&#39;s state is updated throughout the production run, and reporters are set up to </span>
<span class="sd">            record trajectory and simulation data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prod_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">total_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span>
        <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span>
            
        <span class="c1"># Extract positional info</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Define state object </span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">()</span> <span class="c1"># Obtain positions of the particles from previous step</span>
        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span> <span class="c1"># Obtain periodc box vectors of the previous step</span>
        
        <span class="c1"># Set up integrator</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">LangevinIntegrator</span><span class="p">(</span><span class="n">temp</span><span class="o">*</span><span class="n">kelvin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction_coeff</span><span class="o">/</span><span class="n">picoseconds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="o">*</span><span class="n">femtoseconds</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;AMB&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ANI&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">PLatform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>  
        
        <span class="c1"># Update positional info</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
        
        <span class="c1"># Set up reporters</span>
        <span class="c1"># PDB trajectory - this is slighlty redundant with the addition of the DCD trajectory, but it is still useful for </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savepdb_traj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_prod_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">PDBReporter</span><span class="p">(</span><span class="n">output_pdbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">))</span>
        
        <span class="c1"># DCD trajectory</span>
        <span class="c1">#output_dcdname = os.path.join(directories.systems_dir, self.filename, (self.filename + &quot;_prod_traj&quot;))</span>
        <span class="n">output_dcdname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_prod_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="n">dcdWriter</span> <span class="o">=</span> <span class="n">DcdWriter</span><span class="p">(</span><span class="n">output_dcdname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcdWriter</span><span class="o">.</span><span class="n">dcdReporter</span><span class="p">)</span>
    
        <span class="c1"># Datawriter - This is a more complete data writer than previously used, the file generated is a comma delimited text file</span>
        <span class="c1">#output_dataname = os.path.join(directories.systems_dir, self.filename, (self.filename + &quot;_prod_data&quot;))</span>
        <span class="n">output_dataname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_prod_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="n">dataWriter</span> <span class="o">=</span> <span class="n">DataWriter</span><span class="p">(</span><span class="n">output_dataname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataWriter</span><span class="o">.</span><span class="n">stateDataReporter</span><span class="p">)</span> 
        <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">total_steps</span><span class="p">)</span>

        <span class="n">prod_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time_taken</span> <span class="o">=</span> <span class="n">prod_end_time</span> <span class="o">-</span> <span class="n">prod_start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;basic_NVT&#39;</span><span class="p">][</span><span class="s1">&#39;Time taken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_taken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;basic_NVT&#39;</span><span class="p">][</span><span class="s1">&#39;Simulation time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;basic_NVT&#39;</span><span class="p">][</span><span class="s1">&#39;Temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;basic_NVT&#39;</span><span class="p">][</span><span class="s1">&#39;Timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="c1"># Write the final structure to pdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;final_prod_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_pdbname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(),</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="p">(</span><span class="n">output_dataname</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">))</span></div>

        
<div class="viewcode-block" id="BuildSimulation.thermal_ramp">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.thermal_ramp">[docs]</a>
    <span class="k">def</span> <span class="nf">thermal_ramp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">heating</span><span class="p">,</span> <span class="n">quench_rate</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">,</span> <span class="n">start_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a thermal ramp (heating or cooling) on the simulation system.</span>

<span class="sd">        This method adjusts the system&#39;s temperature incrementally, either heating or cooling it over</span>
<span class="sd">        a range of temperatures in defined steps. It supports both NVT and NPT ensembles, and allows</span>
<span class="sd">        for detailed reporting of the simulation process.</span>

<span class="sd">        Args:</span>
<span class="sd">            simulation (app.Simulation): The simulation object on which the thermal ramp is performed.</span>
<span class="sd">            heating (bool): If True, the system is heated; if False, the system is cooled.</span>
<span class="sd">            quench_rate (int): The temperature increment (in Kelvin) between successive steps of the ramp.</span>
<span class="sd">            ensemble (str): The ensemble used for the ramp, either &quot;NVT&quot; (constant volume) or &quot;NPT&quot; (constant pressure).</span>
<span class="sd">            start_temp (float, optional): The starting temperature for the ramp. Defaults to the first value in `self.anneal_parameters`.</span>
<span class="sd">            max_temp (float, optional): The maximum temperature for the ramp. Defaults to the second value in `self.anneal_parameters`.</span>
<span class="sd">            total_steps (int, optional): The total number of steps for the ramp. Defaults to `self.total_steps`.</span>
<span class="sd">            pressure (float, optional): The pressure to use in NPT ensemble. Defaults to `self.pressure`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: The updated simulation object and the path to the output data file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an invalid ensemble is specified.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - This method uses a Langevin integrator with the specified starting temperature.</span>
<span class="sd">            - The simulation system can be either AMBER (AMB) or ANI type.</span>
<span class="sd">            - Various simulation data and trajectories are saved, including DCD and PDB files.</span>
<span class="sd">            - The function updates internal logs with details of the thermal ramp.</span>

<span class="sd">        Example:</span>
<span class="sd">            simulation = app.Simulation(topology, system, integrator)</span>
<span class="sd">            ramp = self.thermal_ramp(simulation, heating=True, quench_rate=10, ensemble=&quot;NVT&quot;, start_temp=300, max_temp=500)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ensemble</span> <span class="o">==</span> <span class="s2">&quot;NVT&quot;</span> <span class="ow">or</span> <span class="n">ensemble</span> <span class="o">==</span> <span class="s2">&quot;NPT&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;NVT&#39; or &#39;NPT&#39; ensemble for the thermal ramp&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>
            
        <span class="n">thermal_ramp_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">start_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anneal_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">max_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anneal_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span>
        <span class="k">if</span> <span class="n">total_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span>

        <span class="c1"># Extract positional info</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Define state object </span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">()</span> <span class="c1"># Obtain positions of the particles from previous step</span>
        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span> <span class="c1"># Obtain periodc box vectors of the previous step</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Periodic box vectors are: &quot;</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
        
        <span class="c1"># Set up integrator</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">LangevinIntegrator</span><span class="p">(</span><span class="n">start_temp</span><span class="o">*</span><span class="n">kelvin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction_coeff</span><span class="o">/</span><span class="n">picoseconds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="o">*</span><span class="n">femtoseconds</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;AMB&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ensemble</span> <span class="o">==</span> <span class="s2">&quot;NPT&quot;</span><span class="p">:</span>
                <span class="n">barostat</span> <span class="o">=</span> <span class="n">MonteCarloBarostat</span><span class="p">((</span><span class="n">pressure</span><span class="o">*</span><span class="n">atmosphere</span><span class="p">),</span> <span class="p">((</span><span class="n">start_temp</span> <span class="k">if</span> <span class="n">heating</span><span class="o">==</span><span class="kc">True</span> <span class="k">else</span> <span class="n">max_temp</span><span class="p">)</span><span class="o">*</span><span class="n">kelvin</span><span class="p">))</span>
                <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">barostat</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ANI&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">PLatform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>

        <span class="c1"># Update the xyz of each atom</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>

        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;heat&quot;</span> <span class="k">if</span> <span class="n">heating</span><span class="o">==</span><span class="kc">True</span> <span class="k">else</span> <span class="s2">&quot;cool&quot;</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_temp_ramp_&quot;</span> <span class="o">+</span> <span class="n">method</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">start_temp</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">max_temp</span><span class="p">)</span><span class="si">}</span><span class="s2">_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        
        <span class="c1"># Set up reporters</span>
        <span class="c1"># PDB trajectory - this is slighlty redundant with the addition of the DCD trajectory, but it is still useful for </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savepdb_traj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">output_filename</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span> <span class="p">))</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">PDBReporter</span><span class="p">(</span><span class="n">output_pdbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">))</span>
        
        <span class="c1"># DCD trajectory</span>
        <span class="n">output_dcdname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
        <span class="n">dcdWriter</span> <span class="o">=</span> <span class="n">DcdWriter</span><span class="p">(</span><span class="n">output_dcdname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcdWriter</span><span class="o">.</span><span class="n">dcdReporter</span><span class="p">)</span>
    
        <span class="c1"># Datawriter - This is a more complete data writer than previously used, the file generated is a comma delimited text file</span>
        <span class="n">output_dataname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
        <span class="n">dataWriter</span> <span class="o">=</span> <span class="n">DataWriter</span><span class="p">(</span><span class="n">output_dataname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataWriter</span><span class="o">.</span><span class="n">stateDataReporter</span><span class="p">)</span>
        
        <span class="n">incremental_temps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_temp</span><span class="p">,</span> <span class="n">max_temp</span> <span class="o">+</span> <span class="n">quench_rate</span><span class="p">,</span> <span class="n">quench_rate</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
     
        <span class="k">if</span> <span class="n">heating</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># List will be low to high</span>
        <span class="k">if</span> <span class="n">heating</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">incremental_temps</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span> <span class="c1"># List now high to low for cooling</span>
         
        <span class="n">steps_at_increment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_steps</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">incremental_temps</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">incremental_temps</span><span class="p">)):</span>
            <span class="n">integrator</span><span class="o">.</span><span class="n">setTemperature</span><span class="p">(</span><span class="n">incremental_temps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">steps_at_increment</span><span class="p">)</span>

        <span class="n">thermal_ramp_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time_taken</span> <span class="o">=</span> <span class="n">thermal_ramp_start_time</span> <span class="o">-</span> <span class="n">thermal_ramp_end_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Thermal Ramp&#39;</span><span class="p">][</span><span class="s1">&#39;Time taken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_taken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Thermal Ramp&#39;</span><span class="p">][</span><span class="s1">&#39;Simulation time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_steps</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Thermal Ramp&#39;</span><span class="p">][</span><span class="s1">&#39;Start temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Thermal Ramp&#39;</span><span class="p">][</span><span class="s1">&#39;Target temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Thermal Ramp&#39;</span><span class="p">][</span><span class="s1">&#39;Quench Rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quench_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Thermal Ramp&#39;</span><span class="p">][</span><span class="s1">&#39;Steps at incremental temps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps_at_increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Thermal Ramp&#39;</span><span class="p">][</span><span class="s1">&#39;Timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Thermal Ramp&#39;</span><span class="p">][</span><span class="s1">&#39;Ensemble&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Thermal Ramp&#39;</span><span class="p">][</span><span class="s1">&#39;Method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;heating&quot;</span> <span class="k">if</span> <span class="n">heating</span><span class="o">==</span><span class="kc">True</span> <span class="k">else</span> <span class="s2">&quot;cooling&quot;</span> 

        <span class="c1"># Write the final structure to pdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;final_&quot;</span> <span class="o">+</span> <span class="n">output_filename</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_pdbname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(),</span> <span class="n">output</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="p">(</span><span class="n">output_dataname</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">))</span></div>

        
<div class="viewcode-block" id="BuildSimulation.strain">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.strain">[docs]</a>
    <span class="k">def</span> <span class="nf">strain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">total_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to perform a production run simulation with the provided parameters.</span>
<span class="sd">        </span>
<span class="sd">        USAGE: </span>
<span class="sd">            production_run_sim = sim.anneal(simulation, total_steps, temp)            </span>
<span class="sd">        </span>
<span class="sd">        Recommended USAGE:</span>
<span class="sd">            production_run_sim = sim.anneal(simulation)</span>
<span class="sd">            </span>
<span class="sd">            where annealing parameters are set with the following functions:</span>
<span class="sd">                </span>
<span class="sd">            simulation_object.set_temperature(temperature)</span>
<span class="sd">            simulation_object.set_total_steps(total_steps)</span>
<span class="sd">            </span>
<span class="sd">        Args:</span>
<span class="sd">            simulation (app.Simulation): The simulation object to run the production simulation on.</span>
<span class="sd">            </span>
<span class="sd">            total_steps (int, optional): The total number of steps to run for the production simulation. </span>
<span class="sd">                Defaults to None, in which case the value is fetched from self.total_steps.</span>
<span class="sd">            </span>
<span class="sd">            temp (float, optional): The temperature for the production simulation in Kelvin. </span>
<span class="sd">                Defaults to None, in which case the value is fetched from self.temp.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing the simulation object after the production run and the filename of the data file generated.</span>
<span class="sd">                in the following format:</span>
<span class="sd">                </span>
<span class="sd">            (simulation_object, path_to_data_file)</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method performs a production run simulation with the provided simulation object and parameters.</span>
<span class="sd">            It initializes the system with the provided initial conditions and runs the simulation for the specified </span>
<span class="sd">            number of steps. The system&#39;s state is updated throughout the production run, and reporters are set up to </span>
<span class="sd">            record trajectory and simulation data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prod_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">total_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span>
        <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span>
            
        <span class="c1"># Extract positional info</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Define state object </span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">()</span> <span class="c1"># Obtain positions of the particles from previous step</span>
        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span> <span class="c1"># Obtain periodc box vectors of the previous step</span>
        
        <span class="c1"># Set up integrator</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">LangevinIntegrator</span><span class="p">(</span><span class="n">temp</span><span class="o">*</span><span class="n">kelvin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction_coeff</span><span class="o">/</span><span class="n">picoseconds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="o">*</span><span class="n">femtoseconds</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;AMB&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">barostat</span> <span class="o">=</span> <span class="n">MonteCarloBarostat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="o">*</span><span class="n">atmosphere</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">*</span><span class="n">kelvin</span><span class="p">))</span>
            <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">barostat</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">BuildSimulation</span><span class="o">.</span><span class="n">type_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ANI&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonbondedcutoff</span><span class="o">*</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">)</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">PLatform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>  
        
        <span class="c1"># Update positional info</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
        
        <span class="c1"># Set up reporters</span>
        <span class="c1"># PDB trajectory - this is slighlty redundant with the addition of the DCD trajectory, but it is still useful for </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savepdb_traj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output_pdbname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_strain_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">PDBReporter</span><span class="p">(</span><span class="n">output_pdbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">))</span>
        
        <span class="c1"># DCD trajectory</span>
        <span class="c1">#output_dcdname = os.path.join(directories.systems_dir, self.filename, (self.filename + &quot;_prod_traj&quot;))</span>
        <span class="n">output_dcdname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_strain_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="n">dcdWriter</span> <span class="o">=</span> <span class="n">DcdWriter</span><span class="p">(</span><span class="n">output_dcdname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcdWriter</span><span class="o">.</span><span class="n">dcdReporter</span><span class="p">)</span>
    
        <span class="c1"># Datawriter - This is a more complete data writer than previously used, the file generated is a comma delimited text file</span>
        <span class="c1">#output_dataname = os.path.join(directories.systems_dir, self.filename, (self.filename + &quot;_prod_data&quot;))</span>
        <span class="n">output_dataname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_strain_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="n">dataWriter</span> <span class="o">=</span> <span class="n">DataWriter</span><span class="p">(</span><span class="n">output_dataname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataWriter</span><span class="o">.</span><span class="n">stateDataReporter</span><span class="p">)</span> 
        
        <span class="n">total_strain</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">strain_steps</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">strain_increment</span> <span class="o">=</span> <span class="n">total_strain</span><span class="o">/</span><span class="n">strain_steps</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">strain_steps</span><span class="p">):</span>
            <span class="n">new_vx</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strain_increment</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">new_vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

        <span class="n">prod_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time_taken</span> <span class="o">=</span> <span class="n">prod_end_time</span> <span class="o">-</span> <span class="n">prod_start_time</span>
        <span class="c1">#self.log_info[&#39;Production&#39;][&#39;Time taken&#39;] = time_taken</span>
        <span class="c1">#self.log_info[&#39;Production&#39;][&#39;Simulation time&#39;] = total_steps * self.timestep</span>
        <span class="c1">#self.log_info[&#39;Production&#39;][&#39;Temperature&#39;] = temp</span>
        <span class="c1">#self.log_info[&#39;Production&#39;][&#39;Timestep&#39;] = self.timestep</span>
        <span class="k">return</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="p">(</span><span class="n">output_dataname</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">))</span></div>


    
<div class="viewcode-block" id="BuildSimulation.production_run_help">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.production_run_help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">production_run_help</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display help information for the production run method.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">production_run</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="BuildSimulation.__repr__">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.__repr__">[docs]</a>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representation of the simulation parameters for debugging and logging purposes.</span>

<span class="sd">        This method prints and returns a formatted string that includes key simulation parameters:</span>
<span class="sd">        pressure, temperature, timestep, friction coefficient, total steps, and reporter frequency.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A formatted string representing the simulation parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulation parameters: (&#39;</span><span class="si">{}</span><span class="s2">&#39;, &#39;</span><span class="si">{}</span><span class="s2">&#39;, &#39;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction_coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter_freq</span><span class="p">))</span>
        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;Simulation parameters given in the following format: (&#39;</span><span class="si">{}</span><span class="s2">&#39;, &#39;</span><span class="si">{}</span><span class="s2">&#39;, &#39;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;timestep&quot;</span><span class="p">,</span> <span class="s2">&quot;friction coefficient&quot;</span><span class="p">,</span> <span class="s2">&quot;total steps&quot;</span><span class="p">,</span> <span class="s2">&quot;reporter freqeuncy&quot;</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="BuildSimulation.__str__">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a user-friendly string representation of the simulation object.</span>

<span class="sd">        This method provides a concise description of the simulation, including its associated filename.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string describing the simulation object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;Simulation object of - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BuildSimulation.display_start_time">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.display_start_time">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">display_start_time</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the simulation start time.</span>

<span class="sd">        This class method prints the timestamp indicating when the simulation was initiated.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls (type): The class on which the method is called.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulation initiated at: &quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildSimulation.savepdb_trajectories">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.savepdb_trajectories">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">savepdb_trajectories</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set whether to save simulation trajectories in PDB format.</span>

<span class="sd">        This method allows the user to toggle the saving of simulation trajectories</span>
<span class="sd">        in both PDB and DCD formats. If enabled, trajectories are saved in both formats;</span>
<span class="sd">        otherwise, only DCD format is used.</span>

<span class="sd">        Args:</span>
<span class="sd">            boolean (bool): A flag indicating whether to save PDB trajectories.</span>
<span class="sd">                        - `True` to save both PDB and DCD formats.</span>
<span class="sd">                        - `False` to save only DCD format.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the provided argument is not a boolean.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Example:</span>
<span class="sd">            # Enable PDB trajectory saving</span>
<span class="sd">            Simulation.savepdb_trajectories(True)</span>

<span class="sd">            # Disable PDB trajectory saving</span>
<span class="sd">            Simulation.savepdb_trajectories(False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boolean</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please pass True or False to this function.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">savepdb_traj</span> <span class="o">=</span> <span class="n">boolean</span>
        <span class="k">if</span> <span class="n">boolean</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulation will save trajectories in both .pdb and .dcd format.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulation will save trajectories in .dcd format only.&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BuildSimulation.set_temperature">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.set_temperature">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_temperature</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">temp</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to set the temperature for simulations.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls: The class itself.</span>
<span class="sd">            temp (float): The temperature to set, in Kelvin.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method sets the temperature class attribute to the specified value and prints a confirmation message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Temperature set to: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s2">&quot;kelvin&quot;</span><span class="p">)</span></div>

             
<div class="viewcode-block" id="BuildSimulation.set_pressure">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.set_pressure">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_pressure</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pressure</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to set the pressure for simulations.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls: The class itself.</span>
<span class="sd">            pressure (float): The pressure to set, in Atmospheres.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method sets the pressure class attribute to the specified value and prints a confirmation message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">raise_pressure</span> <span class="o">=</span> <span class="n">pressure</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pressure set to: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pressure</span><span class="p">),</span> <span class="s2">&quot; atmospheres&quot;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="BuildSimulation.set_timestep">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.set_timestep">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_timestep</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">timestep</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to set the timestep for simulations.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls: The class itself.</span>
<span class="sd">            timestep (float): The timestep to set, in Femtoseconds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method sets the timestep class attribute to the specified value and prints a confirmation message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Timestep set to: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestep</span><span class="p">))</span></div>

        
<div class="viewcode-block" id="BuildSimulation.set_friction_coeff">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.set_friction_coeff">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_friction_coeff</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">friction_coeff</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to set the friction_coeff for simulations.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls: The class itself.</span>
<span class="sd">            friction_coeff (float): The friction_coeff to set, in Picoseconds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method sets the friction_coeff class attribute to the specified value and prints a confirmation message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">friction_coeff</span> <span class="o">=</span> <span class="n">friction_coeff</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Friction coeffiecent set to: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">friction_coeff</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="BuildSimulation.set_total_steps">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.set_total_steps">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_total_steps</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to set the total_steps for simulations.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls: The class itself.</span>
<span class="sd">            total_steps (int): The total_steps to set, as an integer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method sets the total_steps class attribute to the specified value and prints a confirmation message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">total_steps</span> <span class="o">=</span> <span class="n">total_steps</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total steps for simulation set to: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_steps</span><span class="p">))</span></div>

        
<div class="viewcode-block" id="BuildSimulation.set_reporter_freq">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.set_reporter_freq">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_reporter_freq</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">reporter_freq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to set the reporter_freq for simulations.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls: The class itself.</span>
<span class="sd">            reporter_freq (int): The reporter_freq to set, as an integer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method sets the reporter_freq class attribute to the specified value and prints a confirmation message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">reporter_freq</span> <span class="o">=</span> <span class="n">reporter_freq</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reporter frequency set to every: &quot;</span><span class="p">,</span> <span class="n">reporter_freq</span><span class="p">,</span> <span class="s2">&quot; steps&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildSimulation.set_nonbondedcutoff">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.set_nonbondedcutoff">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_nonbondedcutoff</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nonbondedcutoff</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the non-bonded cutoff distance for the simulation.</span>

<span class="sd">        This method allows the user to update the non-bonded cutoff distance, which</span>
<span class="sd">        determines how far the simulation considers interactions between non-bonded</span>
<span class="sd">        particles.</span>

<span class="sd">        Args:</span>
<span class="sd">            nonbondedcutoff (float): The new cutoff distance in nanometers.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the provided argument is not a float.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Example:</span>
<span class="sd">            Simulation.set_nonbondedcutoff(5.0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nonbondedcutoff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please pass a float to this method to set a new nonbondedcutoff&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: simulation.set_nonbondedcutoff(5.0)&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">none</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">nonbondedcutoff</span> <span class="o">=</span> <span class="n">nonbondedcutoff</span></div>

        
<div class="viewcode-block" id="BuildSimulation.set_anneal_parameters">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.set_anneal_parameters">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_anneal_parameters</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_anneal_parameters</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to set annealing parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls: The class itself.</span>
<span class="sd">            new_anneal_parameters (list): List of annealing parameters in the format [start_temp, max_temp, cycles, holding_steps, steps_at_temp].</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the length of new_anneal_parameters does not match the expected length.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method sets the annealing parameters class attribute to the specified list. </span>
<span class="sd">            It prints a confirmation message with the provided parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_anneal_parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">anneal_parameters</span><span class="p">):</span>
            <span class="n">format_str</span> <span class="o">=</span> <span class="s2">&quot;Expected format: [start_temp, max_temp, cycles, holding_steps, steps_at_temp]&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid parameters provided. </span><span class="si">{</span><span class="n">format_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="c1"># new_anneal_parameters = [start_temp, max_temp, cycles, holding_steps]</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">anneal_parameters</span> <span class="o">=</span> <span class="n">new_anneal_parameters</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Anneal parameters set.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting temperature is: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_anneal_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Target temperature is: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_anneal_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of annealing cycles is: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_anneal_parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Steps at target/start temperature is: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_anneal_parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Steps at each incremental temperature is: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_anneal_parameters</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span></div>


<div class="viewcode-block" id="BuildSimulation.set_anneal_parameters_help">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.set_anneal_parameters_help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_anneal_parameters_help</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display help information for setting annealing parameters.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">set_anneal_parameters</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span></div>

           
<div class="viewcode-block" id="BuildSimulation.graph_state_data">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.graph_state_data">[docs]</a>
    <span class="nd">@staticmethod</span>  <span class="c1"># Dont take instance or class - can run this without an instance</span>
    <span class="k">def</span> <span class="nf">graph_state_data</span><span class="p">(</span><span class="n">data_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to generate a plot from simulation data and save it as a PNG file.</span>
<span class="sd">        </span>
<span class="sd">        USAGE:</span>
<span class="sd">            The variable used for this plot is the second element of the tuple coming from the following method:</span>
<span class="sd">                **anneal**</span>
<span class="sd">                **equilibrate**</span>
<span class="sd">                **production_run**</span>
<span class="sd">                </span>
<span class="sd">            sim.graph_state_data(returned_simulation_variable)</span>
<span class="sd">            </span>
<span class="sd">            An example of this returned_simulation_varaible is:</span>
<span class="sd">                sim.anneal(minimized_sim)[0]</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            data_file (str): The path to the CSV file containing simulation data.</span>
<span class="sd">            </span>
<span class="sd">        Notes:</span>
<span class="sd">            This method reads simulation data from a CSV file, creates plots for each column of data</span>
<span class="sd">            against time, and saves the resulting plot as a PNG file. The CSV file is expected to have</span>
<span class="sd">            a &quot;Time (ps)&quot; column and numerical data columns representing different states of the</span>
<span class="sd">            simulation over time.</span>

<span class="sd">            The generated plot will contain multiple subplots, each showing a different state variable</span>
<span class="sd">            plotted against time. The number of rows and columns of subplots is determined automatically</span>
<span class="sd">            based on the number of data columns, with a maximum of 2 columns per row. If there are more</span>
<span class="sd">            data columns than can fit in the specified layout, some subplots may be omitted.</span>

<span class="sd">            The PNG file containing the plot will be saved in the same directory as the data file with</span>
<span class="sd">            the same name, but with the extension changed to &quot;.png&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">png_file_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
        
        <span class="n">data_file</span> <span class="o">=</span> <span class="n">data_file</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="c1"># Exclude the last two columns</span>
        <span class="n">columns_to_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Calculate the number of rows and columns needed for subplots</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns_to_plot</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># +1 to ensure an extra row if there&#39;s an odd number of columns</span>
        <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns_to_plot</span><span class="p">))</span>  <span class="c1"># Maximum of 2 columns in each row</span>

        <span class="c1"># Set up subplots in the calculated arrangement</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">num_rows</span><span class="p">))</span>

        <span class="c1"># Plot each column against &quot;Time (ps)&quot; in a separate subplot</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns_to_plot</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">num_cols</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">num_cols</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Time (ps)&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (ps)&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Remove empty subplots if there are not enough columns to fill all slots</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns_to_plot</span><span class="p">),</span> <span class="n">num_rows</span> <span class="o">*</span> <span class="n">num_cols</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">num_cols</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">num_cols</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>  <span class="c1"># Adjust the layout to prevent clipping of the suptitle</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png_file_name</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="BuildSimulation.graph_state_data_help">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.graph_state_data_help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">graph_state_data_help</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display help information for the method to plot state data.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">graph_state_data</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildSimulation.write_log_csv">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.BuildSimulation.write_log_csv">[docs]</a>
    <span class="k">def</span> <span class="nf">write_log_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the log information to a CSV file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method collects all unique keys across all sections of log_info.</span>
<span class="sd">            It then writes the log_info to a CSV file with each section as a row and the keys as columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all unique keys across all sections</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">all_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Write log_info to a CSV file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_csv</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Section&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_keys</span><span class="p">))</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">({</span><span class="s1">&#39;Section&#39;</span><span class="p">:</span> <span class="n">section</span><span class="p">,</span> <span class="o">**</span><span class="n">info</span><span class="p">})</span></div>
</div>

<div class="viewcode-block" id="AmberSimulation">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.AmberSimulation">[docs]</a>
<span class="k">class</span> <span class="nc">AmberSimulation</span><span class="p">(</span><span class="n">BuildSimulation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class representing an AMBER molecular dynamics simulation.</span>

<span class="sd">    This class is designed to initialize and manage an AMBER simulation using specified </span>
<span class="sd">    topology and coordinates files. It inherits from the BuildSimulation class.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        manager (str): A manager object that handles directories and file paths for simulations.</span>
<span class="sd">        filename (str): The base name of the topology file without the extension.</span>
<span class="sd">        amb_coordinates (app.AmberInpcrdFile): An object representing the AMBER coordinates file.</span>
<span class="sd">        amb_topology (app.AmberPrmtopFile): An object representing the AMBER topology file, </span>
<span class="sd">                                            which also includes periodic box vectors.</span>

<span class="sd">    Methods:</span>
<span class="sd">        __new__(cls, *args, **kwargs):</span>
<span class="sd">            Creates a new instance of AmberSimulation. Ensures the correct number of arguments </span>
<span class="sd">            are provided before creating an instance.</span>
<span class="sd">        __init__(self, manager, topology_file, coordinates_file):</span>
<span class="sd">            Initializes an AmberSimulation object with the specified manager, topology file, </span>
<span class="sd">            and coordinates file.</span>
<span class="sd">        __str__(self):</span>
<span class="sd">            Returns a user-friendly string representation of the AmberSimulation object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If an incorrect number of arguments are provided to the __new__ method.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Create a new AmberSimulation object</span>
<span class="sd">        sim = AmberSimulation(manager, &#39;path/to/topology.prmtop&#39;, &#39;path/to/coordinates.inpcrd&#39;)</span>

<span class="sd">        # Print the string representation</span>
<span class="sd">        print(sim)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AmberSimulation.__new__">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.AmberSimulation.__new__">[docs]</a>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Check number of arguments provided</span>
        <span class="c1"># The __new__ method essentially creates a dummy instance before actually creating the real instance </span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;AmberSimulation expected 3 arguments, but </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2"> were given. &quot;</span>
                <span class="s2">&quot;Usage: &#39;sim = AmberSimulation(manager, topology_file, coordinates_file)&#39;&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Call __new__ to continue object creation if the argument count is correct</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="AmberSimulation.__init__">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.AmberSimulation.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">topology_file</span><span class="p">,</span> <span class="n">coordinates_file</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">topology_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Inherit attributes defined in the parent class and pass directories to the BuildSimulation constructor</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">amb_coordinates</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">AmberInpcrdFile</span><span class="p">(</span><span class="n">coordinates_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amb_topology</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">AmberPrmtopFile</span><span class="p">(</span><span class="n">topology_file</span><span class="p">,</span> <span class="n">periodicBoxVectors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amb_coordinates</span><span class="o">.</span><span class="n">boxVectors</span><span class="p">)</span></div>


<div class="viewcode-block" id="AmberSimulation.__str__">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.AmberSimulation.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Amber simulation object of - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="ANISimulation">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.ANISimulation">[docs]</a>
<span class="k">class</span> <span class="nc">ANISimulation</span><span class="p">(</span><span class="n">BuildSimulation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class representing an ANI (Atomic Neural Network Interaction) molecular dynamics simulation.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        potential (str): A string representing the ANI potential used in the simulation.</span>
<span class="sd">        directories (str): A string representing the directories where simulation files are stored.</span>
<span class="sd">        input_file (str): A string representing the path to the input file.</span>

<span class="sd">    Methods:</span>
<span class="sd">        __init__(directories, input_file): </span>
<span class="sd">            Initializes an ANISimulation object with specified directories and input file, sets up ANI coordinates, potential, and topology.</span>
<span class="sd">        __str__():</span>
<span class="sd">            Returns a string representation of the ANISimulation object.</span>
<span class="sd">        set_potential(potential):</span>
<span class="sd">            Class method to set the ANI potential for all instances of the class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">potential</span> <span class="o">=</span> <span class="s1">&#39;ani2x&#39;</span>
    
<div class="viewcode-block" id="ANISimulation.__init__">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.ANISimulation.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directories</span><span class="p">,</span> <span class="n">input_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Inherit attributes defined in the parent class and pass directories to the BuildSimulation constructor</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">directories</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">positionsML</span> <span class="o">=</span> <span class="n">PositionsML</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ani_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positionsML</span><span class="o">.</span><span class="n">coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positionsML</span><span class="o">.</span><span class="n">get_pbc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">potential</span> <span class="o">=</span> <span class="n">MLPotential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ani_topology</span> <span class="o">=</span> <span class="p">((</span><span class="n">TopologyML</span><span class="p">(</span><span class="n">input_file</span><span class="p">))</span><span class="o">.</span><span class="n">create_topo</span><span class="p">())</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span></div>


    
<div class="viewcode-block" id="ANISimulation.__str__">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.ANISimulation.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;ANI simulation object of - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="ANISimulation.set_potential">
<a class="viewcode-back" href="../sw_openmm.html#sw_openmm.ANISimulation.set_potential">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_potential</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">potential</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the potential function for the simulation.</span>

<span class="sd">        This method allows the user to change the potential function used in the simulation. </span>
<span class="sd">        It can be used to swap between different potential models, such as switching to </span>
<span class="sd">        an ANI (Artificial Neural Network) potential.</span>

<span class="sd">        Args:</span>
<span class="sd">            potential (object): The new potential function or object to be used in the simulation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Example:</span>
<span class="sd">            # Set a new potential function</span>
<span class="sd">            AmberSimulation.set_potential(new_potential)</span>

<span class="sd">        Note:</span>
<span class="sd">            This method currently serves as a placeholder for switching to ANI 1 potential, </span>
<span class="sd">            but it can be extended for other potential models as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">potential</span> <span class="o">=</span> <span class="n">potential</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Potential set to: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">potential</span><span class="p">))</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Daniel J. York.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>