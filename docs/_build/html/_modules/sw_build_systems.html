

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sw_build_systems &mdash; Polymer Simulator 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Polymer Simulator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../packagecontents.html">Package Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sw_openmm.html">Module Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sw_build_systems.html">sw_build_systems Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Polymer Simulator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">sw_build_systems</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sw_build_systems</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Mar 19 10:00:30 2024</span>

<span class="sd">@author: danie</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">openbabel</span> <span class="kn">import</span> <span class="n">openbabel</span><span class="p">,</span> <span class="n">pybel</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.rdmolfiles</span> <span class="kn">import</span> <span class="n">MolFromPDBFile</span>

<div class="viewcode-block" id="BuildSystems">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems">[docs]</a>
<span class="k">class</span> <span class="nc">BuildSystems</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for building and simulating molecular systems.</span>

<span class="sd">    Provides methods for converting SMILES strings to PDB files, running simulations,</span>
<span class="sd">    generating residue codes, calculating distances, and aligning molecules.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        packmol_path (str): Path to the Packmol executable.</span>
<span class="sd">        manager (object): Manager object to handle file paths and directories.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">packmol_path</span> <span class="o">=</span> <span class="s2">&quot;/home/dan/packmol-20.14.4-docs1/packmol-20.14.4-docs1/packmol&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the BuildSystems class with the specified manager object.</span>

<span class="sd">        Args:</span>
<span class="sd">            manager (object): The manager object for interacting with directories and files.</span>
<span class="sd">        &quot;&quot;&quot;</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
    
<div class="viewcode-block" id="BuildSystems.SmilesToPDB">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.SmilesToPDB">[docs]</a>
    <span class="k">def</span> <span class="nf">SmilesToPDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_string</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a SMILES string to a PDB file.</span>

<span class="sd">        Args:</span>
<span class="sd">            smiles_string (str): The SMILES string of the molecule.</span>
<span class="sd">            output_file (str): The name of the output PDB file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Writes the 3D structure of the molecule to a PDB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a molecule from the SMILES string</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="n">pybel</span><span class="o">.</span><span class="n">readstring</span><span class="p">(</span><span class="s2">&quot;smi&quot;</span><span class="p">,</span> <span class="n">smiles_string</span><span class="p">)</span>

        <span class="c1"># Generate the 3D structure</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">make3D</span><span class="p">()</span>

        <span class="c1"># Convert the molecule to PDB format</span>
        <span class="n">pdb_string</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pdb&quot;</span><span class="p">)</span>

        <span class="c1"># Write the PDB string to a file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pdb_string</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildSystems.SmilesToPDB_GenResCode">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.SmilesToPDB_GenResCode">[docs]</a>
    <span class="k">def</span> <span class="nf">SmilesToPDB_GenResCode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a SMILES string to a PDB file and generates a residue code if not found.</span>

<span class="sd">        Args:</span>
<span class="sd">            smiles (str): The SMILES string of the molecule.</span>
<span class="sd">            name (str): The name of the molecule.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Writes the PDB file and updates the residue code CSV.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">forbidden_codes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AAA&quot;</span><span class="p">,</span> <span class="s2">&quot;BBB&quot;</span><span class="p">,</span> <span class="s2">&quot;CCC&quot;</span><span class="p">,</span> <span class="s2">&quot;UNL&quot;</span><span class="p">,</span> <span class="s2">&quot;ALA&quot;</span><span class="p">,</span> <span class="s2">&quot;ARG&quot;</span><span class="p">,</span> <span class="s2">&quot;ASN&quot;</span><span class="p">,</span> <span class="s2">&quot;ASP&quot;</span><span class="p">,</span> <span class="s2">&quot;ASX&quot;</span><span class="p">,</span> <span class="s2">&quot;CYS&quot;</span><span class="p">,</span> <span class="s2">&quot;GLU&quot;</span><span class="p">,</span> <span class="s2">&quot;GLN&quot;</span><span class="p">,</span> <span class="s2">&quot;GLX&quot;</span><span class="p">,</span> <span class="s2">&quot;HIS&quot;</span><span class="p">,</span> <span class="s2">&quot;ILE&quot;</span><span class="p">,</span> <span class="s2">&quot;LEU&quot;</span><span class="p">,</span> <span class="s2">&quot;LYS&quot;</span><span class="p">,</span> <span class="s2">&quot;MET&quot;</span><span class="p">,</span> <span class="s2">&quot;PHE&quot;</span><span class="p">,</span> <span class="s2">&quot;PRO&quot;</span><span class="p">,</span> <span class="s2">&quot;SER&quot;</span><span class="p">,</span> <span class="s2">&quot;THR&quot;</span><span class="p">,</span> <span class="s2">&quot;SEC&quot;</span><span class="p">,</span> <span class="s2">&quot;TRP&quot;</span><span class="p">,</span> <span class="s2">&quot;TYR&quot;</span><span class="p">,</span> <span class="s2">&quot;VAL&quot;</span><span class="p">]</span>
        <span class="c1"># Load existing residue codes from the CSV file</span>
        <span class="n">residue_codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_residue_codes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">residue_code_csv</span><span class="p">)</span>
        <span class="c1"># Check if the name or smiles is already in the database</span>
        <span class="n">existing_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_existing_entry</span><span class="p">(</span><span class="n">residue_codes</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">smiles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_entry</span><span class="p">:</span>
            <span class="c1"># Use existing residue code</span>
            <span class="n">residue_code</span> <span class="o">=</span> <span class="n">existing_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Assuming code is the third column</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Generate a unique 3-letter residue code excluding forbidden codes</span>
            <span class="n">residue_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_unique_residue_code</span><span class="p">(</span><span class="n">residue_codes</span><span class="p">,</span> <span class="n">forbidden_codes</span><span class="p">)</span>
            <span class="c1"># Update the CSV file with the new entry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_residue_codes_csv</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">residue_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">residue_code_csv</span><span class="p">)</span>
        <span class="c1"># Replace default &quot;UNL&quot; codes in the PDB content - NOTE, &quot;UNL&quot; is also a forbidden code as it is the default code.</span>
        <span class="n">pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">pdb_file_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SmilesToPDB</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">pdb_filepath</span><span class="p">)</span>    
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb_filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdb_file</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">pdb_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>     
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; UNL&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">residue_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>   
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb_filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdb_file</span><span class="p">:</span>              
            <span class="n">pdb_file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildSystems.load_residue_codes">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.load_residue_codes">[docs]</a>
    <span class="k">def</span> <span class="nf">load_residue_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residue_code_csv</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads existing residue codes from a CSV file.</span>

<span class="sd">        Args:</span>
<span class="sd">            residue_code_csv (str): The path to the residue code CSV file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of residue codes from the CSV file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load existing residue codes from the CSV file</span>
        <span class="n">residue_codes</span> <span class="o">=</span> <span class="p">[]</span>	
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">residue_code_csv</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
            <span class="n">residue_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">residue_codes</span></div>


<div class="viewcode-block" id="BuildSystems.generate_unique_residue_code">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.generate_unique_residue_code">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_unique_residue_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residue_codes</span><span class="p">,</span> <span class="n">forbidden_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a unique 3-letter residue code not in the forbidden or existing codes.</span>

<span class="sd">        Args:</span>
<span class="sd">            residue_codes (list): List of existing residue codes.</span>
<span class="sd">            forbidden_codes (list, optional): List of forbidden residue codes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A unique 3-letter residue code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate a unique 3-letter residue code not already in the database and not in the forbidden codes list</span>
        <span class="n">existing_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">residue_codes</span><span class="p">)</span>  <span class="c1"># Assuming code is the third column</span>
        <span class="n">forbidden_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">forbidden_codes</span><span class="p">)</span> <span class="k">if</span> <span class="n">forbidden_codes</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Generate all possible combinations of three letters</span>
        <span class="n">all_combinations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">combination</span><span class="p">)</span> <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">)]</span>

        <span class="c1"># Find the first unused code not in the forbidden codes list</span>
        <span class="n">new_code</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">all_combinations</span> <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_codes</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">forbidden_codes</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to generate a unique residue code.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_code</span></div>


<div class="viewcode-block" id="BuildSystems.GenRescode_4_PolyUnits">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.GenRescode_4_PolyUnits">[docs]</a>
    <span class="k">def</span> <span class="nf">GenRescode_4_PolyUnits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates residue codes for polymeric units (e.g., trimers) and updates the CSV.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name of the trimer molecule.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Updates the residue code CSV.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;trimer&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Polymeric unit generation requires trimers. Please consult the build systems guide for information on how to do this&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>
    
        <span class="n">forbidden_codes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AAA&quot;</span><span class="p">,</span> <span class="s2">&quot;BBB&quot;</span><span class="p">,</span> <span class="s2">&quot;CCC&quot;</span><span class="p">,</span> <span class="s2">&quot;UNL&quot;</span><span class="p">,</span> <span class="s2">&quot;ALA&quot;</span><span class="p">,</span> <span class="s2">&quot;ARG&quot;</span><span class="p">,</span> <span class="s2">&quot;ASN&quot;</span><span class="p">,</span> <span class="s2">&quot;ASP&quot;</span><span class="p">,</span> <span class="s2">&quot;ASX&quot;</span><span class="p">,</span> <span class="s2">&quot;CYS&quot;</span><span class="p">,</span> <span class="s2">&quot;GLU&quot;</span><span class="p">,</span> <span class="s2">&quot;GLN&quot;</span><span class="p">,</span> <span class="s2">&quot;GLX&quot;</span><span class="p">,</span> <span class="s2">&quot;HIS&quot;</span><span class="p">,</span> <span class="s2">&quot;ILE&quot;</span><span class="p">,</span> <span class="s2">&quot;LEU&quot;</span><span class="p">,</span> <span class="s2">&quot;LYS&quot;</span><span class="p">,</span> <span class="s2">&quot;MET&quot;</span><span class="p">,</span> <span class="s2">&quot;PHE&quot;</span><span class="p">,</span> <span class="s2">&quot;PRO&quot;</span><span class="p">,</span> <span class="s2">&quot;SER&quot;</span><span class="p">,</span> <span class="s2">&quot;THR&quot;</span><span class="p">,</span> <span class="s2">&quot;SEC&quot;</span><span class="p">,</span> <span class="s2">&quot;TRP&quot;</span><span class="p">,</span> <span class="s2">&quot;TYR&quot;</span><span class="p">,</span> <span class="s2">&quot;VAL&quot;</span><span class="p">]</span>
   
        <span class="c1"># Load existing residue codes from the CSV file</span>
        <span class="n">residue_codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_residue_codes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">residue_code_csv</span><span class="p">)</span>
    
        <span class="c1"># Check if the name or smiles is already in the database</span>
        <span class="n">existing_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_existing_entry</span><span class="p">(</span><span class="n">residue_codes</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_entry</span><span class="p">:</span>
            <span class="c1"># Use existing residue code</span>
            <span class="n">residue_code</span> <span class="o">=</span> <span class="n">existing_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Assuming code is the third column  </span>
            <span class="n">residue_smiles</span> <span class="o">=</span> <span class="n">existing_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Assuming SMILES is the second column</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_entry</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please parameterize the initial trimer unit and generate a residue code for it using it&#39;s SMILES string&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>

        <span class="c1"># New codes and names for residue code csv are specified here.</span>
        <span class="n">head_code</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span> <span class="o">+</span> <span class="n">residue_code</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">mainchain_code</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span> <span class="o">+</span> <span class="n">residue_code</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">tail_code</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span> <span class="o">+</span> <span class="n">residue_code</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">head_name</span> <span class="o">=</span> <span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">mainchain_name</span> <span class="o">=</span> <span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">tail_name</span> <span class="o">=</span> <span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="c1"># A tag is also placed in front of the SMILES. Note, this should not be required, but the residue code file will not update unless a new SMILES AND molecule name are passed to it. In this case, the SMILES for each unit are simply the same SMILES as the trimer but with a h,m,t tag in front of the SMILES.</span>
        <span class="n">head_smiles</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span> <span class="o">+</span> <span class="n">residue_smiles</span>
        <span class="n">mainchain_smiles</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span> <span class="o">+</span> <span class="n">residue_smiles</span>
        <span class="n">tail_smiles</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span> <span class="o">+</span> <span class="n">residue_smiles</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">update_residue_codes_csv</span><span class="p">(</span><span class="n">head_name</span><span class="p">,</span> <span class="n">head_smiles</span><span class="p">,</span> <span class="n">head_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">residue_code_csv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_residue_codes_csv</span><span class="p">(</span><span class="n">mainchain_name</span><span class="p">,</span> <span class="n">mainchain_smiles</span><span class="p">,</span> <span class="n">mainchain_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">residue_code_csv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_residue_codes_csv</span><span class="p">(</span><span class="n">tail_name</span><span class="p">,</span> <span class="n">tail_smiles</span><span class="p">,</span> <span class="n">tail_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">residue_code_csv</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Head code assigned: &quot;</span><span class="p">,</span> <span class="n">head_code</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mainchain code assigned: &quot;</span><span class="p">,</span> <span class="n">mainchain_code</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tail code assigned: &quot;</span><span class="p">,</span> <span class="n">tail_code</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BuildSystems.update_residue_codes_csv">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.update_residue_codes_csv">[docs]</a>
    <span class="k">def</span> <span class="nf">update_residue_codes_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">residue_code</span><span class="p">,</span> <span class="n">residue_code_csv</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the CSV file with a new residue code entry.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name of the molecule.</span>
<span class="sd">            smiles (str): The SMILES representation of the molecule.</span>
<span class="sd">            residue_code (str): The residue code to be added.</span>
<span class="sd">            residue_code_csv (str): Path to the CSV file for residue codes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Appends the new residue code to the CSV file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update the CSV file with the new entry if it doesn&#39;t exist</span>
        <span class="n">residue_codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_residue_codes</span><span class="p">(</span><span class="n">residue_code_csv</span><span class="p">)</span>
        <span class="n">existing_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_existing_entry</span><span class="p">(</span><span class="n">residue_codes</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">smiles</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_entry</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">residue_code_csv</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>

                <span class="c1"># Add a new entry to the CSV file</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">residue_code</span><span class="p">])</span></div>


<div class="viewcode-block" id="BuildSystems.find_existing_entry">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.find_existing_entry">[docs]</a>
    <span class="k">def</span> <span class="nf">find_existing_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residue_codes</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds an existing residue code entry by molecule name or SMILES string.</span>

<span class="sd">        Args:</span>
<span class="sd">            residue_codes (list): The list of existing residue codes.</span>
<span class="sd">            name (str): The name of the molecule.</span>
<span class="sd">            smiles (str, optional): The SMILES string of the molecule.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list or None: The matching entry if found, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">smiles</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">residue_codes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">entry</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">residue_codes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">smiles</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">entry</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="BuildSystems.run_packmol">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.run_packmol">[docs]</a>
    <span class="k">def</span> <span class="nf">run_packmol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the Packmol simulation with the specified input file.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_file_name (str): The name of the Packmol input file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Executes Packmol simulation using the provided input file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">packmol_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Packmol executable exists at &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">packmol_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Packmol executable not found at &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">packmol_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please update the class variable for the packmol path using &#39;update_packmol_path(new_packmol_path)&#39;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Call packmol_help() for more information&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>
        <span class="n">packmol_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pckml_filepath</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">packmol_filepath</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Packmol input file exists at &#39;</span><span class="si">{</span><span class="n">packmol_filepath</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Packmol input file not found.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>
        <span class="n">system_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="n">input_file_name</span><span class="p">)</span>
        <span class="n">packmol_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packmol_path</span> <span class="o">+</span> <span class="s2">&quot; &lt; &quot;</span> <span class="o">+</span> <span class="n">packmol_filepath</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">packmol_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span><span class="p">()</span></div>


<div class="viewcode-block" id="BuildSystems.update_packmol_path">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.update_packmol_path">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">update_packmol_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_packmol_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the path to the Packmol executable.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_packmol_path (str): The new path to the Packmol executable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Updates the class-level variable for the Packmol path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_packmol_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packmol_path</span> <span class="o">=</span> <span class="n">new_packmol_path</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Packmol path updated to &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">packmol_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The provided path &#39;</span><span class="si">{</span><span class="n">new_packmol_path</span><span class="si">}</span><span class="s2">&#39; does not exist. Please provide a valid path.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildSystems.get_xyz_dists">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.get_xyz_dists">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_xyz_dists</span><span class="p">(</span><span class="n">input_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the maximum distance between the largest and smallest XYZ coordinates in a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_file (str): Path to a &#39;.pdb&#39; or &#39;.xyz&#39; file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Maximum distances along the x, y, and z axes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">input_file</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide a valid input file.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Supported formats are: &#39;.pdb&#39; and &#39;.xyz&#39;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1">#self.get_xyz_dists_help()</span>
            <span class="k">return</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s2">&quot;.pdb&quot;</span> <span class="ow">in</span> <span class="n">input_file</span><span class="p">:</span>
            <span class="n">obConversion</span> <span class="o">=</span> <span class="n">openbabel</span><span class="o">.</span><span class="n">OBConversion</span><span class="p">()</span>
            <span class="n">obConversion</span><span class="o">.</span><span class="n">SetInFormat</span><span class="p">(</span><span class="s2">&quot;pdb&quot;</span><span class="p">)</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">openbabel</span><span class="o">.</span><span class="n">OBMol</span><span class="p">()</span>
            <span class="n">obConversion</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">input_file</span><span class="p">)</span>
            <span class="c1"># Extract atom coordinates</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">openbabel</span><span class="o">.</span><span class="n">OBMolAtomIter</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom</span><span class="o">.</span><span class="n">GetX</span><span class="p">(),</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetY</span><span class="p">(),</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetZ</span><span class="p">()))</span>

        <span class="k">if</span> <span class="s2">&quot;.xyz&quot;</span> <span class="ow">in</span> <span class="n">input_file</span><span class="p">:</span>
            <span class="n">obConversion</span> <span class="o">=</span> <span class="n">openbabel</span><span class="o">.</span><span class="n">OBConversion</span><span class="p">()</span>
            <span class="n">obConversion</span><span class="o">.</span><span class="n">SetInFormat</span><span class="p">(</span><span class="s2">&quot;xyz&quot;</span><span class="p">)</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">openbabel</span><span class="o">.</span><span class="n">OBMol</span><span class="p">()</span>
            <span class="n">obConversion</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">openbabel</span><span class="o">.</span><span class="n">OBMolAtomIter</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom</span><span class="o">.</span><span class="n">GetX</span><span class="p">(),</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetY</span><span class="p">(),</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetZ</span><span class="p">()))</span>
    
        <span class="c1"># Convert to numpy array for easy manipulation</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        
        <span class="c1"># Calculate max and min for each axis</span>
        <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">max_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">min_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate the distances</span>
        <span class="n">dist_x</span> <span class="o">=</span> <span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span>
        <span class="n">dist_y</span> <span class="o">=</span> <span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span>
        <span class="n">dist_z</span> <span class="o">=</span> <span class="n">max_z</span> <span class="o">-</span> <span class="n">min_z</span>

        <span class="k">return</span><span class="p">(</span><span class="n">dist_x</span><span class="p">,</span> <span class="n">dist_y</span><span class="p">,</span> <span class="n">dist_z</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildSystems.get_xyz_dists_help">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.get_xyz_dists_help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_xyz_dists_help</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays help information for the `get_xyz_dists` method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Prints out the docstring of `get_xyz_dists` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_xyz_dists</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This method calculates the maximum distance between the largest and smallest xyz coordinates&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;from a PDB or XYZ file.&quot;</span><span class="p">)</span></div>

           
<div class="viewcode-block" id="BuildSystems.align_molecule">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildSystems.align_molecule">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">align_molecule</span><span class="p">(</span><span class="n">input_pdb</span><span class="p">,</span> <span class="n">axis_to_align</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aligns the molecule structure to a specified axis (X, Y, or Z).</span>

<span class="sd">        Args:</span>
<span class="sd">            input_file (str): Path to a PDB file containing the molecule.</span>
<span class="sd">            axis (str): The axis to align the molecule to (&#39;X&#39;, &#39;Y&#39;, or &#39;Z&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: The aligned structure is saved with a new file name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">MDAnalysis</span> <span class="k">as</span> <span class="nn">mda</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span> <span class="k">as</span> <span class="n">R</span>
            
        <span class="n">u</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">input_pdb</span><span class="p">)</span>
            
        <span class="c1"># Select the atom group for alignment (you can specify your selection if needed)</span>
        <span class="n">ag</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">atoms</span>

        <span class="c1"># Compute the principal axes using the mass-weighted inertia tensor</span>
        <span class="n">principal_axes</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">principal_axes</span><span class="p">()</span>

        <span class="c1"># Define the target axis, which is along the z-axis ([0, 0, 1])</span>
        <span class="n">z_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">y_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># Get the principal axis that we want to align with the z-axis (typically the first one, corresponding to the largest eigenvalue)</span>
        <span class="n">principal_axis_to_align</span> <span class="o">=</span> <span class="n">principal_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compute the rotation needed to align the principal axis with the z-axis</span>
        <span class="k">if</span> <span class="n">axis_to_align</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">z_axis</span>
        <span class="k">elif</span> <span class="n">axis_to_align</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">x_axis</span>
        <span class="k">elif</span> <span class="n">axis_to_align</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">y_axis</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide arugment as: &#39;X&#39; OR &#39;Y&#39; OR &#39;Z&#39;&quot;</span><span class="p">)</span>
            
        <span class="n">rotation</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">align_vectors</span><span class="p">([</span><span class="n">principal_axis_to_align</span><span class="p">],</span> <span class="p">[</span><span class="n">axis</span><span class="p">])</span>

        <span class="c1"># Apply the rotation to the entire molecule</span>
        <span class="n">ag</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">rotation</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>

        <span class="c1"># Save the aligned molecule to a new PDB file</span>
        <span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">input_pdb</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">input_pdb</span><span class="p">)</span></div>
</div>

            
            

<div class="viewcode-block" id="BuildAmberSystems">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems">[docs]</a>
<span class="k">class</span> <span class="nc">BuildAmberSystems</span><span class="p">(</span><span class="n">BuildSystems</span><span class="p">):</span>
    
    <span class="n">error_param</span> <span class="o">=</span> <span class="s2">&quot;Molecule not parametrized. Please parametrize pdb_file.&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
    
<div class="viewcode-block" id="BuildAmberSystems.mod_pdb_file">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.mod_pdb_file">[docs]</a>
    <span class="k">def</span> <span class="nf">mod_pdb_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">):</span> <span class="c1"># pdb_file is the entire path to the pdb_file - see jupyter notebook</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify a PDB file by removing duplicate bond information.</span>
<span class="sd">         Note: parametrization does not work if double bond connections are specified.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - pdb_file (str): The full path to the PDB file.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>

<span class="sd">        This function reads a PDB file, removes duplicate bond information in lines starting with &quot;CONECT&quot;,</span>
<span class="sd">        and writes the modified content back to the same file.</span>

<span class="sd">        Note: The modification involves removing duplicate atom connection information while maintaining the original order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">pdb_file</span>  
        <span class="c1"># Open the file and read its lines</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="c1"># Process each line</span>
        <span class="n">modified_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="c1"># Process lines starting with &quot;CONECT&quot;</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;CONECT&quot;</span><span class="p">):</span>
                <span class="c1"># Split the line into numbers</span>
                <span class="n">numbers</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="c1"># Remove duplicates while maintaining order</span>
                <span class="n">unique_numbers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">numbers</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">numbers</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="c1"># Join the modified numbers and reconstruct the line</span>
                <span class="n">modified_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_numbers</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">modified_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modified_line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modified_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="c1"># Write the modified lines back to the file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">modified_lines</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BuildAmberSystems.parameterize_mol">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.parameterize_mol">[docs]</a>
    <span class="k">def</span> <span class="nf">parameterize_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span>  <span class="n">molecule_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide 1 argument as follows: parametrize_mol(molecule_name)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Directories: A python object generated with the PolymerSimulatorDirs(filepath) method imported from sw_directories&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Molecule name: A string of the molecule name, i.e. &#39;Ethane&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Create a new directory for param files for the molecule and copy pdb there</span>
        <span class="n">pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">pdb_file_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod_pdb_file</span><span class="p">(</span><span class="n">pdb_filepath</span><span class="p">)</span>
        <span class="n">param_mol_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">param_mol_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">param_mol_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">pdb_filepath</span><span class="p">,</span> <span class="n">param_mol_dir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pdb_filepath</span><span class="p">)</span>
        
        <span class="c1"># Specify paths for tleap</span>
        <span class="n">pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_mol_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
        <span class="n">mol2_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_mol_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.mol2&quot;</span><span class="p">))</span>
        <span class="n">antechamber_command</span> <span class="o">=</span> <span class="s2">&quot;antechamber -i &quot;</span> <span class="o">+</span> <span class="n">pdb_filepath</span> <span class="o">+</span> <span class="s2">&quot; -fi pdb -o &quot;</span> <span class="o">+</span> <span class="n">mol2_filepath</span> <span class="o">+</span> <span class="s2">&quot; -fo mol2 -c bcc -s 2&quot;</span>       
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">antechamber_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
        <span class="n">frcmod_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_mol_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.frcmod&quot;</span><span class="p">))</span>
        <span class="n">parmchk_command</span> <span class="o">=</span> <span class="s2">&quot;parmchk2 -i &quot;</span> <span class="o">+</span> <span class="n">mol2_filepath</span> <span class="o">+</span> <span class="s2">&quot; -f mol2 -o &quot;</span> <span class="o">+</span> <span class="n">frcmod_filepath</span>      
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">parmchk_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">lib_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_mol_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.lib&quot;</span><span class="p">))</span>
        <span class="n">intleap_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_mol_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.intleap&quot;</span><span class="p">))</span>
        
        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;source leaprc.protein.ff14SB</span>
<span class="s2">        source leaprc.gaff</span>
<span class="s2">        source leaprc.water.fb3</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name</span><span class="si">}</span><span class="s2"> = loadmol2 </span><span class="si">{</span><span class="n">mol2_filepath</span><span class="si">}</span>
<span class="s2">        saveoff </span><span class="si">{</span><span class="n">molecule_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">lib_filepath</span><span class="si">}</span>
<span class="s2">        quit</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intleap_filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="n">leap_command</span> <span class="o">=</span> <span class="s2">&quot;tleap -f &quot;</span> <span class="o">+</span> <span class="n">intleap_filepath</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">leap_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_prepin_file_sing_mol</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.gen_ac_file">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.gen_ac_file">[docs]</a>
    <span class="k">def</span> <span class="nf">gen_ac_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># This function isn&#39;t required so much - however it will generate .ac files </span>
        <span class="k">if</span> <span class="n">molecule_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide 1 argument as follows: gen_ac_file(molecule_name)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Molecule name: A string of the molecule name, i.e. &#39;Ethane&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">mol2_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.mol2&quot;</span>
        <span class="n">ac_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ac&quot;</span>
        <span class="n">antechamber_command</span> <span class="o">=</span> <span class="s2">&quot;antechamber -fi mol2 -fo ac -i &quot;</span> <span class="o">+</span> <span class="n">mol2_name</span> <span class="o">+</span> <span class="s2">&quot; -o &quot;</span> <span class="o">+</span> <span class="n">ac_name</span> <span class="o">+</span> <span class="s2">&quot; -c bcc -s 2&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">antechamber_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.gen_prepin_files">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.gen_prepin_files">[docs]</a>
    <span class="k">def</span> <span class="nf">gen_prepin_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">):</span>
        <span class="c1"># NOTE: this function is for generating prepin files of polymers, for single molecules, please use &#39;gen_prepin_files_single_mol&#39;</span>
        <span class="k">if</span> <span class="n">molecule_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide 1 argument as follows: gen_prepin_files(molecule_name)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Molecule name: A string of the molecule name, i.e. &#39;Ethane&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Find the path of the molecule directory (where all the required files are required)</span>
        <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please parameterize molecule.&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>  
    
        <span class="c1"># Define file names required for prepgen</span>
        <span class="n">head_file</span> <span class="o">=</span> <span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">head_prepin_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">,</span> <span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">)</span>
        <span class="n">mainchain_file</span> <span class="o">=</span> <span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">mainchain_prepin_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">,</span> <span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">)</span>
        <span class="n">tail_file</span> <span class="o">=</span> <span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">tail_prepin_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">,</span> <span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">)</span>
        <span class="n">ac_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">,</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.ac&quot;</span><span class="p">)</span>
    
        <span class="c1"># Check if the required files exist</span>
        <span class="n">segment_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">head_file</span><span class="p">,</span> <span class="n">mainchain_file</span><span class="p">,</span> <span class="n">tail_file</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">segment_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please prepare files defining each segment of the trimer. Head, mainchain and tail. Call build_systems.prepin_help() for more information.&quot;</span><span class="p">)</span>
                <span class="k">return</span><span class="p">()</span> 

        <span class="c1"># Retrieve the residue codes from the database</span>
        <span class="n">head_rescode</span><span class="p">,</span> <span class="n">mainchain_rescode</span><span class="p">,</span> <span class="n">tail_rescode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">retrieve_polymeric_rescodes</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">head_rescode</span><span class="p">,</span> <span class="n">mainchain_rescode</span><span class="p">,</span> <span class="n">tail_rescode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">head_rescode</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">mainchain_rescode</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tail_rescode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Residue codes for polymeric units not generated. Please generate them with &#39;build.GenRescode_4_PolyUnits(&#39;ethane&#39;)&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>

        <span class="c1"># Define the prepgen commands with the collated information</span>
        <span class="n">head_command</span> <span class="o">=</span> <span class="s2">&quot;prepgen -i &quot;</span> <span class="o">+</span> <span class="n">ac_name</span> <span class="o">+</span> <span class="s2">&quot; -o &quot;</span> <span class="o">+</span> <span class="n">head_prepin_file</span> <span class="o">+</span> <span class="s2">&quot; -f prepi -m &quot;</span> <span class="o">+</span> <span class="n">head_file</span> <span class="o">+</span> <span class="s2">&quot; -rn &quot;</span> <span class="o">+</span> <span class="n">head_rescode</span> <span class="o">+</span> <span class="s2">&quot; -rf &quot;</span> <span class="o">+</span> <span class="n">head_rescode</span> <span class="o">+</span> <span class="s2">&quot;.res&quot;</span>
        <span class="n">mainchain_command</span> <span class="o">=</span> <span class="s2">&quot;prepgen -i &quot;</span> <span class="o">+</span> <span class="n">ac_name</span> <span class="o">+</span> <span class="s2">&quot; -o &quot;</span> <span class="o">+</span> <span class="n">mainchain_prepin_file</span> <span class="o">+</span> <span class="s2">&quot; -f prepi -m &quot;</span> <span class="o">+</span> <span class="n">mainchain_file</span> <span class="o">+</span> <span class="s2">&quot; -rn &quot;</span> <span class="o">+</span> <span class="n">mainchain_rescode</span> <span class="o">+</span> <span class="s2">&quot; -rf &quot;</span> <span class="o">+</span> <span class="n">mainchain_rescode</span> <span class="o">+</span> <span class="s2">&quot;.res&quot;</span>
        <span class="n">tail_command</span> <span class="o">=</span> <span class="s2">&quot;prepgen -i &quot;</span> <span class="o">+</span> <span class="n">ac_name</span> <span class="o">+</span> <span class="s2">&quot; -o &quot;</span> <span class="o">+</span> <span class="n">tail_prepin_file</span> <span class="o">+</span> <span class="s2">&quot; -f prepi -m &quot;</span> <span class="o">+</span> <span class="n">tail_file</span> <span class="o">+</span> <span class="s2">&quot; -rn &quot;</span> <span class="o">+</span> <span class="n">tail_rescode</span> <span class="o">+</span> <span class="s2">&quot; -rf &quot;</span> <span class="o">+</span> <span class="n">tail_rescode</span> <span class="o">+</span> <span class="s2">&quot;.res&quot;</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">head_command</span><span class="p">,</span> <span class="n">mainchain_command</span><span class="p">,</span> <span class="n">tail_command</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Command executed successfully</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Command failed, print error message</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Exception occurred during subprocess execution</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">main_dir</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.gen_prepin_file_sing_mol">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.gen_prepin_file_sing_mol">[docs]</a>
    <span class="k">def</span> <span class="nf">gen_prepin_file_sing_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">molecule_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide 1 argument as follows: gen_prepin_files(molecule_name)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Molecule name: A string of the molecule name, i.e. &#39;Ethane&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            
        <span class="c1"># Find the path of the molecule directory (where all the required files are required)</span>
        <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please parameterize molecule.&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>  
    
        <span class="c1"># Define file names required for prepgen</span>
        <span class="n">prepi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">,</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">)</span>
        <span class="n">pdb_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">,</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
        <span class="n">frcmod_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">,</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.frcmod&quot;</span><span class="p">)</span>

        <span class="n">antechamber_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;antechamber -i </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2"> -fi pdb -o </span><span class="si">{</span><span class="n">prepi_file</span><span class="si">}</span><span class="s2"> -fo prepi -c bcc -s 2&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">antechamber_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">parmchk_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;parmchk2 -i </span><span class="si">{</span><span class="n">prepi_file</span><span class="si">}</span><span class="s2"> -f prepi -o </span><span class="si">{</span><span class="n">frcmod_file</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">antechamber_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BuildAmberSystems.is_mol_parametrized">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.is_mol_parametrized">[docs]</a>
    <span class="k">def</span> <span class="nf">is_mol_parametrized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">molecule_name</span><span class="p">):</span>
        <span class="n">param_mol_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
        <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">pdb_file_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
        <span class="n">pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_mol_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
        <span class="n">mol2_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_mol_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.mol2&quot;</span><span class="p">))</span>
        <span class="n">files_exist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pdb_filepath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mol2_filepath</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">files_exist</span><span class="p">)</span> <span class="c1"># This will be true or false</span></div>


<div class="viewcode-block" id="BuildAmberSystems.is_poly_prepped">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.is_poly_prepped">[docs]</a>
    <span class="k">def</span> <span class="nf">is_poly_prepped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">):</span>
        <span class="n">poly_prepped_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
        <span class="n">head_prepi_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">poly_prepped_dir</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">))</span>
        <span class="n">mainchain_prepi_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">poly_prepped_dir</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">))</span>
        <span class="n">tail_prepi_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">poly_prepped_dir</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">))</span>
        <span class="n">files_exist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">head_prepi_filepath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mainchain_prepi_filepath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tail_prepi_filepath</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">files_exist</span><span class="p">)</span> <span class="c1"># This will be true or false</span></div>


<div class="viewcode-block" id="BuildAmberSystems.pdb_2_mol2">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.pdb_2_mol2">[docs]</a>
    <span class="k">def</span> <span class="nf">pdb_2_mol2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">):</span>
        <span class="n">mol2_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdb_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.mol2&quot;</span>
        <span class="n">babel_command</span> <span class="o">=</span> <span class="s2">&quot;obabel -ipdb &quot;</span> <span class="o">+</span> <span class="n">pdb_file</span> <span class="o">+</span> <span class="s2">&quot; -omol2 -O &quot;</span> <span class="o">+</span> <span class="n">mol2_file</span> <span class="o">+</span> <span class="s2">&quot; --partialcharge gasteiger&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">babel_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
               <span class="c1"># Command executed successfully</span>
               <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>  
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.relax_molecule">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.relax_molecule">[docs]</a>
    <span class="k">def</span> <span class="nf">relax_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">,</span> <span class="n">forcefield</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Relax the molecule using the specified force field.</span>

<span class="sd">        This isn&#39;t useful for polymers as wiggly conformations can be generated, this will also fail when there are very large molecules with many degrees of freedom</span>
<span class="sd">        It is advised to used this function for small molecules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    
        <span class="c1"># Optimize the geometry</span>
        <span class="k">if</span> <span class="n">forcefield</span> <span class="o">==</span> <span class="s1">&#39;UFF&#39;</span><span class="p">:</span>
            <span class="n">AllChem</span><span class="o">.</span><span class="n">UFFOptimizeMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">maxIters</span><span class="o">=</span><span class="n">max_iters</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">forcefield</span> <span class="o">==</span> <span class="s1">&#39;MMFF&#39;</span><span class="p">:</span>
            <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFOptimizeMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">maxIters</span><span class="o">=</span><span class="n">max_iters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown force field: </span><span class="si">{</span><span class="n">forcefield</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        <span class="c1"># Write the relaxed molecule to the output PDB file</span>
        <span class="k">with</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PDBWriter</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">mol</span></div>


<div class="viewcode-block" id="BuildAmberSystems.extract_coordinates_from_pdb">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.extract_coordinates_from_pdb">[docs]</a>
    <span class="k">def</span> <span class="nf">extract_coordinates_from_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts coordinates from a PDB file.</span>

<span class="sd">        Args:</span>
<span class="sd">            pdb_file (str): Path to the PDB file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list of tuples: A list of (x, y, z) coordinates for each atom.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ATOM&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HETATM&quot;</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">coordinates</span></div>


<div class="viewcode-block" id="BuildAmberSystems.replace_coordinates_in_pdb">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.replace_coordinates_in_pdb">[docs]</a>
    <span class="k">def</span> <span class="nf">replace_coordinates_in_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_pdb_file</span><span class="p">,</span> <span class="n">pdb_file_with_new_coords</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replaces the coordinates in the original PDB file with new coordinates and writes to a new file.</span>

<span class="sd">        Args:</span>
<span class="sd">            original_pdb_file (str): Path to the original PDB file.</span>
<span class="sd">            pdb_file_with_new_coords (str): Path to the PDB file with the new coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_coordinates_from_pdb</span><span class="p">(</span><span class="n">pdb_file_with_new_coords</span><span class="p">)</span>
    
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">original_pdb_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="c1"># Modify the lines with new coordinates</span>
        <span class="n">updated_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">coord_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ATOM&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HETATM&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">coord_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_coordinates</span><span class="p">):</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_coordinates</span><span class="p">[</span><span class="n">coord_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">8.3f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">new_y</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_coordinates</span><span class="p">[</span><span class="n">coord_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">8.3f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">new_z</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_coordinates</span><span class="p">[</span><span class="n">coord_index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">8.3f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}{</span><span class="n">new_x</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}{</span><span class="n">new_y</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}{</span><span class="n">new_z</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}{</span><span class="n">line</span><span class="p">[</span><span class="mi">54</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">coord_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1">#print(new_line)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">updated_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
       
        <span class="c1"># Write the updated content back to the original file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">original_pdb_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">updated_lines</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BuildAmberSystems.gen_polymer_pdb">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.gen_polymer_pdb">[docs]</a>
    <span class="k">def</span> <span class="nf">gen_polymer_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">number_of_units</span><span class="p">,</span> <span class="n">infinite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a polymer PDB file using `tleap` based on the specified molecule and number of units.</span>

<span class="sd">        Args:</span>
<span class="sd">            molecule_name (str): The base name of the molecule to be used for generating the polymer.</span>
<span class="sd">            number_of_units (int): The number of units in the polymer.</span>

<span class="sd">        NOTE: The molecule name should be something like &quot;3HB_trimer&quot; and &#39;.prepi&#39; files should be available for that molecule.</span>
<span class="sd">            (these are required for using tleap to make polymers)</span>

<span class="sd">        Description:</span>
<span class="sd">            This function performs the following steps:</span>
<span class="sd">            1. Changes the working directory to the specified molecule&#39;s directory.</span>
<span class="sd">            2. Constructs file paths for the required input files (`head`, `mainchain`, and `tail` prepi files) and the</span>
<span class="sd">               output directory.</span>
<span class="sd">            3. Creates the output directory if it does not already exist.</span>
<span class="sd">            4. Constructs the polymer name and the paths for the output files (`prmtop`, `rst7`, and `pdb`).</span>
<span class="sd">            5. Retrieves residue codes for the polymeric units from the `dirs` object.</span>
<span class="sd">            6. Constructs the polymer sequence command for `tleap`.</span>
<span class="sd">            7. Creates the `tleap` input script (`.intleap` file) with the appropriate commands to generate the polymer.</span>
<span class="sd">            8. Executes the `tleap` command to generate the polymer, capturing and printing the output or errors.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If there is an error changing the directory or executing the `tleap` command.</span>

<span class="sd">        Example Usage:</span>
<span class="sd">            dirs = DirectoryPaths(&#39;path/to/main/project/directory&#39;)</span>
<span class="sd">            gen_polymer_pdb(dirs, &quot;3HB_trimer&quot;, 10)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current directory:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        
        <span class="n">file_subtype</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_of_units</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_polymer&quot;</span>
        <span class="n">head_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        <span class="n">tail_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        <span class="n">mainchain_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>

        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">file_subtype</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">polymer_name</span> <span class="o">=</span> <span class="n">molecule_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_of_units</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_polymer&quot;</span>
        <span class="k">if</span> <span class="n">infinite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">polymer_name</span> <span class="o">=</span> <span class="n">polymer_name</span> <span class="o">+</span> <span class="s2">&quot;_infinite&quot;</span>

        <span class="n">intleap_path</span> <span class="o">=</span> <span class="n">polymer_name</span> <span class="o">+</span> <span class="s2">&quot;.intleap&quot;</span>
        <span class="n">prmtop_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">polymer_name</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
        <span class="n">rst_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">polymer_name</span> <span class="o">+</span> <span class="s2">&quot;.rst7&quot;</span><span class="p">)</span>
        <span class="n">pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">polymer_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>

        <span class="n">head_rescode</span><span class="p">,</span> <span class="n">mainchain_rescode</span><span class="p">,</span> <span class="n">tail_rescode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">retrieve_polymeric_rescodes</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">infinite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">polymer_code</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">mainchain_rescode</span><span class="p">]</span><span class="o">*</span><span class="n">number_of_units</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">polymer_code</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">head_rescode</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mainchain_rescode</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">number_of_units</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">tail_rescode</span><span class="p">])</span>
        <span class="n">polymer_command</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">polymer_code</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;source leaprc.gaff</span>
<span class="s2">             source leaprc.water.fb3</span>
<span class="s2">             source leaprc.protein.ff14SB</span>

<span class="s2">             loadamberprep </span><span class="si">{</span><span class="n">head_prepi_filepath</span><span class="si">}</span>
<span class="s2">             loadamberprep </span><span class="si">{</span><span class="n">mainchain_prepi_filepath</span><span class="si">}</span>
<span class="s2">             loadamberprep </span><span class="si">{</span><span class="n">tail_prepi_filepath</span><span class="si">}</span>

<span class="s2">             list</span>

<span class="s2">             polymer = sequence </span><span class="si">{</span><span class="n">polymer_command</span><span class="si">}</span>
<span class="s2">             setBox polymer vdw 0.0</span>
<span class="s2">             saveamberparm polymer </span><span class="si">{</span><span class="n">prmtop_filepath</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rst_filepath</span><span class="si">}</span>
<span class="s2">             savepdb polymer </span><span class="si">{</span><span class="n">pdb_filepath</span><span class="si">}</span>
<span class="s2">             quit</span>
<span class="s2">             &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
             <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

        <span class="n">leap_command</span> <span class="o">=</span> <span class="s2">&quot;tleap -f &quot;</span> <span class="o">+</span> <span class="n">intleap_path</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">leap_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
               <span class="c1"># Command executed successfully</span>
               <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">main_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current directory:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pdb_filepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.solvate_molecule">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.solvate_molecule">[docs]</a>
    <span class="k">def</span> <span class="nf">solvate_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">buffer</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="s2">&quot;10&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        
        <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current directory:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">molecule_prepi_filepath</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        <span class="n">molecule_frcmod_filepath</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.frcmod&quot;</span>
    
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_wat_solv&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">molecule_pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz_dists</span><span class="p">(</span><span class="n">molecule_pdb_filepath</span><span class="p">)</span>

        <span class="n">file_subtype</span> <span class="o">=</span> <span class="s2">&quot;_wat_solv&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">buffer</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">intleap_path</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.intleap&quot;</span>

        <span class="n">prmtop_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
        <span class="n">rst_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.rst7&quot;</span><span class="p">)</span>
        <span class="n">pdb_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;OLD FILE CONTENT</span>
<span class="sd">        file_content = f&quot;&quot;&quot;source leaprc.gaff</span>
<span class="sd">            source leaprc.water.fb3</span>

<span class="sd">            loadamberprep {molecule_prepi_filepath}</span>
<span class="sd">            loadamberparams {molecule_frcmod_filepath}</span>

<span class="sd">            {molecule_name} = loadpdb {molecule_pdb_filepath}</span>

<span class="sd">            solvatebox {molecule_name} TIP3PBOX {box_dist_line}</span>

<span class="sd">            saveamberparm {molecule_name} {prmtop_filepath} {rst_filepath}</span>
<span class="sd">            savepdb {molecule_name} {pdb_output}</span>
<span class="sd">            quit</span>
<span class="sd">            &quot;&quot;&quot;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">frcmod_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.frcmod&quot;</span><span class="p">)</span>
        <span class="n">lib_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.lib&quot;</span><span class="p">)</span>
        <span class="n">box_dist_line</span> <span class="o">=</span> <span class="s2">&quot;solvatebox &quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot; TIP3PBOX {&quot;</span> <span class="o">+</span> <span class="n">buffer</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        
        
        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;source leaprc.gaff</span>
<span class="s2">            source leaprc.water.fb3</span>
<span class="s2">            loadamberparams </span><span class="si">{</span><span class="n">frcmod_filepath</span><span class="si">}</span>
<span class="s2">            loadoff </span><span class="si">{</span><span class="n">lib_filepath</span><span class="si">}</span>

<span class="s2">            solvatebox </span><span class="si">{</span><span class="n">molecule_name</span><span class="si">}</span><span class="s2"> TIP3PBOX </span><span class="si">{</span><span class="n">buffer</span><span class="si">}</span>

<span class="s2">            saveamberparm </span><span class="si">{</span><span class="n">molecule_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">prmtop_filepath</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rst_filepath</span><span class="si">}</span>
<span class="s2">            savepdb </span><span class="si">{</span><span class="n">molecule_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pdb_output</span><span class="si">}</span>
<span class="s2">            quit</span>
<span class="s2">            &quot;&quot;&quot;</span>  
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

        <span class="n">leap_command</span> <span class="o">=</span> <span class="s2">&quot;tleap -f &quot;</span> <span class="o">+</span> <span class="n">intleap_path</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">leap_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">main_dir</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.add_ter_to_pckml_result">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.add_ter_to_pckml_result">[docs]</a>
    <span class="k">def</span> <span class="nf">add_ter_to_pckml_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds &#39;TER&#39; records to a PDB file generated by Packmol after each polymer chain.</span>

<span class="sd">        This function is intended to be used after Packmol has built systems of polymers with different</span>
<span class="sd">        head, main, and tail units. Packmol does not add &#39;TER&#39; records after each residue, making it </span>
<span class="sd">        impossible to construct a parameter file. This function remedies that by adding &#39;TER&#39; after each </span>
<span class="sd">        polymer chain in the Packmol file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        dirs (object): An object that provides a method `retrieve_polymeric_rescodes` to retrieve </span>
<span class="sd">                   residue codes for head, mainchain, and tail units.</span>
<span class="sd">        pdb_file (str): The path to the PDB file generated by Packmol.</span>
<span class="sd">        base_molecule_name (str): The base name of the molecule used to identify the polymeric residue codes.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>

<span class="sd">        The function performs the following steps:</span>
<span class="sd">        1. Retrieves the residue codes for the head, mainchain, and tail units.</span>
<span class="sd">        2. Reads the contents of the specified PDB file.</span>
<span class="sd">        3. Iterates through each line in the file to identify points where &#39;TER&#39; records should be added:</span>
<span class="sd">            - Adds a &#39;TER&#39; record when transitioning from a tail residue to a head residue.</span>
<span class="sd">            - Adds a &#39;TER&#39; record before the &#39;END&#39; record in the PDB file.</span>
<span class="sd">        4. Writes the modified contents back to the PDB file with the appropriate &#39;TER&#39; records included.</span>

<span class="sd">        Example usage:</span>
<span class="sd">            add_ter_to_pckml_result(dirs, &#39;polymer_system.pdb&#39;, &#39;3HB_trimer&#39;)</span>

<span class="sd">        Note:</span>
<span class="sd">            A situation where this function is used by itself is not present and it is used as part of the &#39;generate_3_3_polymer_array_pckml&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve residue codes</span>
        <span class="n">head_rescode</span><span class="p">,</span> <span class="n">mainchain_rescode</span><span class="p">,</span> <span class="n">tail_rescode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">retrieve_polymeric_rescodes</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">)</span>

        <span class="c1"># Open file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="c1"># Initiate an empty list foe new lines and set the residue code to None before itereating</span>
        <span class="n">modified_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">previous_residue_code</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Iterate over each line in the file</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="c1"># Split the line into columns based on spaces</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># Extract the current residue code (4th column in this case)</span>
                <span class="n">current_residue_code</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

                <span class="c1"># Check if the previous residue code was &#39;tAD&#39; and the current is &#39;hAD&#39;</span>
                <span class="k">if</span> <span class="n">previous_residue_code</span> <span class="o">==</span> <span class="n">tail_rescode</span> <span class="ow">and</span> <span class="n">current_residue_code</span> <span class="o">==</span> <span class="n">head_rescode</span><span class="p">:</span>
                    <span class="c1"># Append the &quot;TER&quot; line to the modified lines list</span>
                    <span class="n">modified_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;TER</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Update the previous residue code</span>
                <span class="n">previous_residue_code</span> <span class="o">=</span> <span class="n">current_residue_code</span>

            <span class="k">if</span> <span class="s2">&quot;END&quot;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="n">modified_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;TER</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
            <span class="c1"># Append the current line to the modified lines list</span>
            <span class="n">modified_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">modified_lines</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.generate_3_3_polymer_array_crystal">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.generate_3_3_polymer_array_crystal">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_3_3_polymer_array_crystal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Thsis function builds arrays of polymers using the pre generated pdb files</span>
        <span class="k">if</span> <span class="n">molecule_name</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">base_molecule_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
         <span class="c1"># UPDATE THIS</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide 2 arguments as follows: build_3_3_polymer_array(base_molecule_nmae, molecule_name)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Base polymer name: A string of the polymer name, i.e. &#39;3HB_trimer&#39;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Polymer name: A string of the polymer name, i.e. &#39;3HB_10_polymer&#39;&quot;</span><span class="p">)</span>
            
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>        

        <span class="n">pdb_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>
        <span class="n">base_pdb_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">)</span>
         
        <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">)</span>
        <span class="n">cd_command</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span> <span class="o">+</span> <span class="n">molecule_dir</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current directory:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
             
        <span class="n">head_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        <span class="n">mainchain_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        <span class="n">tail_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>

        <span class="n">file_subtype</span> <span class="o">=</span> <span class="s2">&quot;_3_3_array_crystal&quot;</span>
        <span class="n">system_name</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz_dists</span><span class="p">(</span><span class="n">base_pdb_file</span><span class="p">)</span>

        <span class="n">translate_distance</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Removed z as they should not overlap in this distance</span>
        <span class="n">z_trans</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span>
        <span class="n">y_trans</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span>

        <span class="n">molecule_name_1</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_1&quot;</span>
        <span class="n">molecule_name_2</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_2&quot;</span>
        <span class="n">molecule_name_3</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_3&quot;</span>
        <span class="n">molecule_name_4</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_4&quot;</span>
        <span class="n">molecule_name_5</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_5&quot;</span>
        <span class="n">molecule_name_6</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_6&quot;</span>
        <span class="n">molecule_name_7</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_7&quot;</span>
        <span class="n">molecule_name_8</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_8&quot;</span>
        <span class="n">molecule_name_9</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_9&quot;</span>

        <span class="n">translate_line_1</span> <span class="o">=</span> <span class="s2">&quot;{0.0 0.0 0.0}&quot;</span>
        <span class="n">translate_line_2</span> <span class="o">=</span> <span class="s2">&quot;{0.0 0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; }&quot;</span>
        <span class="n">translate_line_3</span> <span class="o">=</span> <span class="s2">&quot;{0.0 0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; }&quot;</span>

        <span class="n">translate_line_4</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_5</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_6</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">translate_line_7</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_8</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_9</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">combine_line</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">molecule_name_1</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_2</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_3</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_4</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_5</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_6</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_7</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_8</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_9</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">base_mol_name</span> <span class="o">=</span> <span class="n">molecule_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intleap_path</span> <span class="o">=</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.intleap&quot;</span>

        <span class="n">prmtop_filepath</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
        <span class="n">rst_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.rst7&quot;</span><span class="p">)</span>
     
        <span class="n">three_three_array_pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
 
        <span class="n">head_rescode</span><span class="p">,</span> <span class="n">mainchain_rescode</span><span class="p">,</span> <span class="n">tail_rescode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">retrieve_polymeric_rescodes</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">)</span>

        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;source leaprc.gaff</span>
<span class="s2">        source leaprc.water.fb3</span>
<span class="s2">        source leaprc.protein.ff14SB</span>

<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">head_prepi_filepath</span><span class="si">}</span>
<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">mainchain_prepi_filepath</span><span class="si">}</span>
<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">tail_prepi_filepath</span><span class="si">}</span>

<span class="s2">        list</span>
<span class="s2">            </span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_2</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_3</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_4</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_5</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_6</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_7</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_8</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_9</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>

<span class="s2">        check </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span>
<span class="s2">         </span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_1</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_2</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_3</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_3</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_4</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_4</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_5</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_6</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_6</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_7</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_7</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_8</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_9</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_9</span><span class="si">}</span>
<span class="s2">         </span>
<span class="s2">        system = combine </span><span class="si">{</span><span class="n">combine_line</span><span class="si">}</span>
<span class="s2">        setBox system vdw 0.0</span>
<span class="s2">        saveamberparm system </span><span class="si">{</span><span class="n">prmtop_filepath</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rst_filepath</span><span class="si">}</span>
<span class="s2">        savepdb system </span><span class="si">{</span><span class="n">three_three_array_pdb_filepath</span><span class="si">}</span>
<span class="s2">    </span>
<span class="s2">        quit</span>
<span class="s2">        &quot;&quot;&quot;</span>
    
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
            
        <span class="n">leap_command</span> <span class="o">=</span> <span class="s2">&quot;tleap -f &quot;</span> <span class="o">+</span> <span class="n">intleap_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">leap_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">cd_command</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">main_dir</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cd_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">system_name</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BuildAmberSystems.generate_3_3_polymer_array_random">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.generate_3_3_polymer_array_random">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_3_3_polymer_array_random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a 3x3 array of polymers using Packmol and adds &#39;TER&#39; records after each polymer chain.</span>

<span class="sd">        This function creates a 3x3 array of polymer molecules based on a given input molecule. It uses Packmol </span>
<span class="sd">        to arrange the molecules in the specified array and adds &#39;TER&#39; records after each polymer chain to ensure </span>
<span class="sd">        proper formatting for subsequent simulations.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        dirs (object): An object that provides methods for directory and file management.</span>
<span class="sd">        molecule_name (str): The name of the molecule to be used for creating the polymer array. i.e. &quot;3HB_10_polymer&quot;</span>
<span class="sd">        base_molecule_name (str): The base name of the molecule used to identify the polymeric residue codes. i.e. &quot;3HB_trimer&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>

<span class="sd">        The function performs the following steps:</span>
<span class="sd">        1. Defines the file subtype and constructs the PDB file path.</span>
<span class="sd">        2. Creates an output directory if it doesn&#39;t exist.</span>
<span class="sd">        3. Constructs the output PDB file name for the unsolved array.</span>
<span class="sd">        4. Calculates the dimensions of the box required to contain the 3x3 array of polymers.</span>
<span class="sd">        5. Generates the Packmol input file content with the specified parameters.</span>
<span class="sd">        6. Writes the Packmol input file to the output directory.</span>
<span class="sd">        7. Executes the Packmol command to generate the unsolved array PDB file.</span>
<span class="sd">        8. Adds &#39;TER&#39; records to the generated PDB file using the `add_ter_to_pckml_result` function.</span>

<span class="sd">        Example usage:</span>
<span class="sd">            generate_3_3_polymer_array_pckml(dirs, &#39;polymer_molecule&#39;, &#39;base_polymer&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_subtype</span> <span class="o">=</span> <span class="s2">&quot;_3_3_array_random&quot;</span>
        <span class="n">pdb_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>
        <span class="n">system_name</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="n">array_pdb_name</span> <span class="o">=</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span>
        <span class="n">array_pdb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">array_pdb_name</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz_dists</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>
        <span class="n">box_edge_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">box_sizes</span> <span class="o">=</span> <span class="n">box_edge_len</span><span class="p">,</span> <span class="n">box_edge_len</span><span class="p">,</span> <span class="n">box_edge_len</span>
        <span class="n">file_content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;tolerance 2.0</span>
<span class="s2">            output </span><span class="si">{</span><span class="n">array_pdb</span><span class="si">}</span>
<span class="s2">            filetype pdb</span>
<span class="s2">            structure </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">            	number 9</span>
<span class="s2">                inside box 0. 0. 0. </span><span class="si">{</span><span class="n">box_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">box_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">box_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span>
<span class="s2">            end structure</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">packmol_input_file</span> <span class="o">=</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.pckml&quot;</span>
        <span class="n">packmol_input_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">packmol_input_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">packmol_input_filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="n">packmol_command</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">packmol_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &lt; &quot;</span> <span class="o">+</span> <span class="n">packmol_input_filepath</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">packmol_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_ter_to_pckml_result</span><span class="p">(</span><span class="n">array_pdb</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">system_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.gen_amber_params_4_pckml_array">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.gen_amber_params_4_pckml_array">[docs]</a>
    <span class="k">def</span> <span class="nf">gen_amber_params_4_pckml_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_name</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">):</span>
        <span class="n">input_pdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">system_name</span><span class="p">)</span>
        
        <span class="n">head_prepi_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">))</span>
        <span class="n">mainchain_prepi_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">))</span>
        <span class="n">tail_prepi_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span><span class="p">))</span>

        <span class="n">file_subtype</span> <span class="o">=</span> <span class="s2">&quot;_3_3_array_random&quot;</span>
        
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">intleap_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.intleap&quot;</span><span class="p">)</span>
        <span class="n">prmtop_filepath</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
        <span class="n">rst_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.rst7&quot;</span><span class="p">)</span>
        <span class="n">head_rescode</span><span class="p">,</span> <span class="n">mainchain_rescode</span><span class="p">,</span> <span class="n">tail_rescode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">retrieve_polymeric_rescodes</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">)</span>

        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;source leaprc.gaff</span>

<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">head_prepi_filepath</span><span class="si">}</span>
<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">mainchain_prepi_filepath</span><span class="si">}</span>
<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">tail_prepi_filepath</span><span class="si">}</span>

<span class="s2">        list</span>
<span class="s2">            </span>
<span class="s2">        system = loadpdb </span><span class="si">{</span><span class="n">input_pdb</span><span class="si">}</span>

<span class="s2">        check</span>

<span class="s2">        setBox system vdw 0.0</span>
<span class="s2">        saveamberparm system </span><span class="si">{</span><span class="n">prmtop_filepath</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rst_filepath</span><span class="si">}</span>

<span class="s2">        quit</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intleap_filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
            
        <span class="n">leap_command</span> <span class="o">=</span> <span class="s2">&quot;tleap -f &quot;</span> <span class="o">+</span> <span class="n">intleap_filepath</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">leap_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">system_name</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="BuildAmberSystems.generate_polymer_3_3_array">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.generate_polymer_3_3_array">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_polymer_3_3_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;crystal&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_3_3_polymer_array_crystal</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_3_3_polymer_array_random</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen_amber_params_4_pckml_array</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">)</span></div>

            
<div class="viewcode-block" id="BuildAmberSystems.generate_5_5_polymer_array_crystal">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.generate_5_5_polymer_array_crystal">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_5_5_polymer_array_crystal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crystal_trans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Thsis function builds arrays of polymers using the pre generated pdb files</span>
        <span class="k">if</span> <span class="n">molecule_name</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">base_molecule_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
         <span class="c1"># UPDATE THIS</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide 2 arguments as follows: build_5_5_polymer_array(base_molecule_nmae, molecule_name)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Base polymer name: A string of the polymer name, i.e. &#39;3HB_trimer&#39;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Polymer name: A string of the polymer name, i.e. &#39;3HB_10_polymer&#39;&quot;</span><span class="p">)</span>
            
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>        

        <span class="n">pdb_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>
        <span class="n">base_pdb_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">)</span>
         
        <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current directory:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
             
        <span class="n">head_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        <span class="n">mainchain_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        <span class="n">tail_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>

        <span class="n">file_subtype</span> <span class="o">=</span> <span class="s2">&quot;_5_5_array_crystal&quot;</span>
        <span class="n">system_name</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz_dists</span><span class="p">(</span><span class="n">base_pdb_file</span><span class="p">)</span>

        <span class="n">translate_distance</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Removed z as they should not overlap in this distance</span>
        <span class="k">if</span> <span class="n">crystal_trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z_trans</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">y_trans</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_trans</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">crystal_trans</span><span class="p">)</span>
            <span class="n">y_trans</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">crystal_trans</span><span class="p">)</span>

        <span class="n">molecule_name_1</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_1&quot;</span>
        <span class="n">molecule_name_2</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_2&quot;</span>
        <span class="n">molecule_name_3</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_3&quot;</span>
        <span class="n">molecule_name_4</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_4&quot;</span>
        <span class="n">molecule_name_5</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_5&quot;</span>
        <span class="n">molecule_name_6</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_6&quot;</span>
        <span class="n">molecule_name_7</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_7&quot;</span>
        <span class="n">molecule_name_8</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_8&quot;</span>
        <span class="n">molecule_name_9</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_9&quot;</span>
        <span class="n">molecule_name_10</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_10&quot;</span>
        <span class="n">molecule_name_11</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_11&quot;</span>
        <span class="n">molecule_name_12</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_12&quot;</span>
        <span class="n">molecule_name_13</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_13&quot;</span>
        <span class="n">molecule_name_14</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_14&quot;</span>
        <span class="n">molecule_name_15</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_15&quot;</span>
        <span class="n">molecule_name_16</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_16&quot;</span>
        <span class="n">molecule_name_17</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_17&quot;</span>
        <span class="n">molecule_name_18</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_18&quot;</span>
        <span class="n">molecule_name_19</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_19&quot;</span>
        <span class="n">molecule_name_20</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_20&quot;</span>
        <span class="n">molecule_name_21</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_21&quot;</span>
        <span class="n">molecule_name_22</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_22&quot;</span>
        <span class="n">molecule_name_23</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_23&quot;</span>
        <span class="n">molecule_name_24</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_24&quot;</span>
        <span class="n">molecule_name_25</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_25&quot;</span>
        

        <span class="n">translate_line_1</span> <span class="o">=</span> <span class="s2">&quot;{0.0 0.0 0.0}&quot;</span>
        <span class="n">translate_line_2</span> <span class="o">=</span> <span class="s2">&quot;{0.0 0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; }&quot;</span>
        <span class="n">translate_line_3</span> <span class="o">=</span> <span class="s2">&quot;{0.0 0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; }&quot;</span>

        <span class="n">translate_line_4</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_5</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_6</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">translate_line_7</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_8</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_9</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">translate_line_10</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_11</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_12</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_13</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_14</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">translate_line_15</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_16</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_17</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_18</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_19</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">translate_line_20</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_21</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">translate_line_22</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_23</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">y_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">translate_line_24</span> <span class="o">=</span> <span class="s2">&quot;{0.0 0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*-</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_25</span> <span class="o">=</span> <span class="s2">&quot;{0.0 0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z_trans</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">combine_line</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">molecule_name_1</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_2</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_3</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_4</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_5</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_6</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_7</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_8</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_9</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_10</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_11</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_12</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_13</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_14</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_15</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_16</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_17</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_18</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_19</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_20</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_21</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_22</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_23</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_24</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_25</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">base_mol_name</span> <span class="o">=</span> <span class="n">molecule_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intleap_path</span> <span class="o">=</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.intleap&quot;</span>

        <span class="n">prmtop_filepath</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
        <span class="n">rst_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.rst7&quot;</span><span class="p">)</span>
     
        <span class="n">three_three_array_pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
 
        <span class="n">head_rescode</span><span class="p">,</span> <span class="n">mainchain_rescode</span><span class="p">,</span> <span class="n">tail_rescode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">retrieve_polymeric_rescodes</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">)</span>

        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;source leaprc.gaff</span>
<span class="s2">        source leaprc.water.fb3</span>
<span class="s2">        source leaprc.protein.ff14SB</span>

<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">head_prepi_filepath</span><span class="si">}</span>
<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">mainchain_prepi_filepath</span><span class="si">}</span>
<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">tail_prepi_filepath</span><span class="si">}</span>

<span class="s2">        list</span>
<span class="s2">            </span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_2</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_3</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_4</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_5</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_6</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_7</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_8</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_9</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_10</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_11</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_12</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_13</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_14</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_15</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_16</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_17</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_18</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_19</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_20</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_21</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_22</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_23</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_24</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_25</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>

<span class="s2">        check </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span>
<span class="s2">         </span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_1</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_2</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_3</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_3</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_4</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_4</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_5</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_6</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_6</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_7</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_7</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_8</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_9</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_9</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_10</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_11</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_11</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_12</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_13</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_13</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_14</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_14</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_15</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_16</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_16</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_17</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_17</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_18</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_18</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_19</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_19</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_20</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_21</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_21</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_22</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_22</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_23</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_23</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_24</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_24</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_25</span><span class="si">}</span>
<span class="s2">         </span>
<span class="s2">        system = combine </span><span class="si">{</span><span class="n">combine_line</span><span class="si">}</span>
<span class="s2">        setBox system vdw 0.0</span>
<span class="s2">        saveamberparm system </span><span class="si">{</span><span class="n">prmtop_filepath</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rst_filepath</span><span class="si">}</span>
<span class="s2">        savepdb system </span><span class="si">{</span><span class="n">three_three_array_pdb_filepath</span><span class="si">}</span>
<span class="s2">    </span>
<span class="s2">        quit</span>
<span class="s2">        &quot;&quot;&quot;</span>
    
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
            
        <span class="n">leap_command</span> <span class="o">=</span> <span class="s2">&quot;tleap -f &quot;</span> <span class="o">+</span> <span class="n">intleap_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">leap_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">cd_command</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">main_dir</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cd_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">system_name</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BuildAmberSystems.generate_5_5_polymer_array_random">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.generate_5_5_polymer_array_random">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_5_5_polymer_array_random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a 5x5 array of polymers using Packmol and adds &#39;TER&#39; records after each polymer chain.</span>

<span class="sd">        This function creates a 5x5 array of polymer molecules based on a given input molecule. It uses Packmol </span>
<span class="sd">        to arrange the molecules in the specified array and adds &#39;TER&#39; records after each polymer chain to ensure </span>
<span class="sd">        proper formatting for subsequent simulations.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        dirs (object): An object that provides methods for directory and file management.</span>
<span class="sd">        molecule_name (str): The name of the molecule to be used for creating the polymer array. i.e. &quot;3HB_10_polymer&quot;</span>
<span class="sd">        base_molecule_name (str): The base name of the molecule used to identify the polymeric residue codes. i.e. &quot;3HB_trimer&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>

<span class="sd">        The function performs the following steps:</span>
<span class="sd">        1. Defines the file subtype and constructs the PDB file path.</span>
<span class="sd">        2. Creates an output directory if it doesn&#39;t exist.</span>
<span class="sd">        3. Constructs the output PDB file name for the unsolved array.</span>
<span class="sd">        4. Calculates the dimensions of the box required to contain the 3x3 array of polymers.</span>
<span class="sd">        5. Generates the Packmol input file content with the specified parameters.</span>
<span class="sd">        6. Writes the Packmol input file to the output directory.</span>
<span class="sd">        7. Executes the Packmol command to generate the unsolved array PDB file.</span>
<span class="sd">        8. Adds &#39;TER&#39; records to the generated PDB file using the `add_ter_to_pckml_result` function.</span>

<span class="sd">        Example usage:</span>
<span class="sd">            generate_3_3_polymer_array_pckml(dirs, &#39;polymer_molecule&#39;, &#39;base_polymer&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_subtype</span> <span class="o">=</span> <span class="s2">&quot;_5_5_array_random&quot;</span>
        <span class="n">pdb_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>
        <span class="n">system_name</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="n">array_pdb_name</span> <span class="o">=</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span>
        <span class="n">array_pdb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">array_pdb_name</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz_dists</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>
        <span class="n">box_edge_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">box_sizes</span> <span class="o">=</span> <span class="n">box_edge_len</span><span class="p">,</span> <span class="n">box_edge_len</span><span class="p">,</span> <span class="n">box_edge_len</span>
        <span class="n">file_content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;tolerance 2.0</span>
<span class="s2">            output </span><span class="si">{</span><span class="n">array_pdb</span><span class="si">}</span>
<span class="s2">            filetype pdb</span>
<span class="s2">            structure </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">            	number 25</span>
<span class="s2">                inside box 0. 0. 0. </span><span class="si">{</span><span class="n">box_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">box_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">box_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span>
<span class="s2">            end structure</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">packmol_input_file</span> <span class="o">=</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.pckml&quot;</span>
        <span class="n">packmol_input_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">packmol_input_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">packmol_input_filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="n">packmol_command</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">packmol_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &lt; &quot;</span> <span class="o">+</span> <span class="n">packmol_input_filepath</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">packmol_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_ter_to_pckml_result</span><span class="p">(</span><span class="n">array_pdb</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">system_name</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="BuildAmberSystems.generate_polymer_5_5_array">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.generate_polymer_5_5_array">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_polymer_5_5_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">crystal_trans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;crystal&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_5_5_polymer_array_crystal</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">crystal_trans</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_5_5_polymer_array_random</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen_amber_params_4_pckml_array</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">)</span>  </div>

            
<div class="viewcode-block" id="BuildAmberSystems.build_2_10_polymer_array">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.build_2_10_polymer_array">[docs]</a>
    <span class="k">def</span> <span class="nf">build_2_10_polymer_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
         <span class="c1"># Thsis function builds arrays of polymers using the pre generated pdb files</span>
         <span class="k">if</span> <span class="n">molecule_name</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">base_molecule_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide 2 arguments as follows: build_2_10_polymer_array(base_molecule_name, molecule_name, finite_polymer)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Base polymer name: A string of the polymer name, i.e. &#39;3HB_trimer&#39;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Polymer name: A string of the polymer name, i.e. &#39;3HB_10_polymer&#39;&quot;</span><span class="p">)</span>
            
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>        

         <span class="k">if</span> <span class="n">buffer</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
             <span class="n">buffer</span> <span class="o">=</span> <span class="s2">&quot;10&quot;</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">buffer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        
         
         <span class="n">pdb_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>
         <span class="n">base_pdb_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">)</span>
         
         <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">)</span>
         <span class="n">cd_command</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span> <span class="o">+</span> <span class="n">molecule_dir</span>
         <span class="nb">print</span><span class="p">(</span><span class="n">cd_command</span><span class="p">)</span>

         <span class="k">try</span><span class="p">:</span>
             <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current directory:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
             
         <span class="n">head_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
         <span class="n">mainchain_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
         <span class="n">tail_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>

         <span class="n">file_subtype</span> <span class="o">=</span> <span class="s2">&quot;_2_10_array&quot;</span> 
         <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span><span class="p">))</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
             <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

         <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz_dists</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>

         <span class="c1">#translate_distance = int(max(x, y)) + 1 # Removed z as they should not overlap in this distance</span>
         <span class="n">translate_distance</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Removed z as they should not overlap in this distance</span>

         <span class="n">molecule_name_1</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_1&quot;</span>
         <span class="n">molecule_name_2</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_2&quot;</span>
         <span class="n">molecule_name_3</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_3&quot;</span>
         <span class="n">molecule_name_4</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_4&quot;</span>
         <span class="n">molecule_name_5</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_5&quot;</span>
         <span class="n">molecule_name_6</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_6&quot;</span>
         <span class="n">molecule_name_7</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_7&quot;</span>
         <span class="n">molecule_name_8</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_8&quot;</span>
         <span class="n">molecule_name_9</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_9&quot;</span>
         <span class="n">molecule_name_10</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_10&quot;</span>
         <span class="n">molecule_name_11</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_11&quot;</span>
         <span class="n">molecule_name_12</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_12&quot;</span>
         <span class="n">molecule_name_13</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_13&quot;</span>
         <span class="n">molecule_name_14</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_14&quot;</span>
         <span class="n">molecule_name_15</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_15&quot;</span>
         <span class="n">molecule_name_16</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_16&quot;</span>
         <span class="n">molecule_name_17</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_17&quot;</span>
         <span class="n">molecule_name_18</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_18&quot;</span>
         <span class="n">molecule_name_19</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_19&quot;</span>
         <span class="n">molecule_name_20</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_20&quot;</span>
         
         <span class="c1"># central 2 polymers on the top line (1,2)</span>
         <span class="n">translate_line_1</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
         <span class="n">translate_line_2</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

         <span class="c1"># central 2 polymers on the bottom line (3,4)</span>
         <span class="n">translate_line_3</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
         <span class="n">translate_line_4</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

         <span class="c1"># Polymers either side of central 2 polymers on the top line (5,6)</span>
         <span class="n">translate_line_5</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
         <span class="n">translate_line_6</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

         <span class="c1"># Polymers either side of central 2 polymers on the bottom line (7,8)</span>
         <span class="n">translate_line_7</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
         <span class="n">translate_line_8</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

         <span class="c1"># Polymers (9,10)</span>
         <span class="n">translate_line_9</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
         <span class="n">translate_line_10</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

         <span class="c1"># Polymers (11,12)</span>
         <span class="n">translate_line_11</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
         <span class="n">translate_line_12</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

         <span class="c1"># Polymers (13,14)</span>
         <span class="n">translate_line_13</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">3.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
         <span class="n">translate_line_14</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">3.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

         <span class="c1"># Polymers (15,16)</span>
         <span class="n">translate_line_15</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">3.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
         <span class="n">translate_line_16</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">3.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

         <span class="c1"># Polymers (17,18)</span>
         <span class="n">translate_line_17</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">4.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
         <span class="n">translate_line_18</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">4.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

         <span class="c1"># Polymers (19,20)</span>
         <span class="n">translate_line_19</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">4.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
         <span class="n">translate_line_20</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">4.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

         <span class="n">combine_line</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">molecule_name_1</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_2</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_3</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_4</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_5</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_6</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_7</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_8</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_9</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_10</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_11</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_12</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_13</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_14</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_15</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_16</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_17</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_18</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_19</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_20</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

         <span class="n">base_mol_name</span> <span class="o">=</span> <span class="n">molecule_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
         <span class="n">intleap_path</span> <span class="o">=</span> <span class="n">base_mol_name</span> <span class="o">+</span> <span class="n">file_subtype</span> <span class="o">+</span> <span class="s2">&quot;.intleap&quot;</span>

         <span class="n">system_name</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span>
         <span class="n">unsolved_system_name</span> <span class="o">=</span> <span class="s2">&quot;unsolved_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span>
        
         <span class="n">prmtop_filepath</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
         <span class="n">rst_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.rst7&quot;</span><span class="p">)</span>

         <span class="n">unsolved_prmtop_filepath</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;unsolved_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
         <span class="n">unsolved_rst_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;unsolved_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span> <span class="o">+</span> <span class="s2">&quot;.rst7&quot;</span><span class="p">)</span>
        
         <span class="n">two_ten_array_pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
         <span class="n">unsolved_two_ten_array_pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;unsolved_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
    
         <span class="n">head_rescode</span><span class="p">,</span> <span class="n">mainchain_rescode</span><span class="p">,</span> <span class="n">tail_rescode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">retrieve_polymeric_rescodes</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">)</span>

         <span class="n">file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;source leaprc.gaff</span>
<span class="s2">         source leaprc.water.fb3</span>
<span class="s2">         source leaprc.protein.ff14SB</span>

<span class="s2">         loadamberprep </span><span class="si">{</span><span class="n">head_prepi_filepath</span><span class="si">}</span>
<span class="s2">         loadamberprep </span><span class="si">{</span><span class="n">mainchain_prepi_filepath</span><span class="si">}</span>
<span class="s2">         loadamberprep </span><span class="si">{</span><span class="n">tail_prepi_filepath</span><span class="si">}</span>

<span class="s2">         list</span>
<span class="s2">            </span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_2</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_3</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_4</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_5</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_6</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_7</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_8</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_9</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_10</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_11</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_12</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_13</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_14</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_15</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_16</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_17</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_18</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_19</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span><span class="si">{</span><span class="n">molecule_name_20</span><span class="si">}</span><span class="s2"> = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">         </span>
<span class="s2">         check </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span>
<span class="s2">         </span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_1</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_2</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_3</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_3</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_4</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_4</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_5</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_6</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_6</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_7</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_7</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_8</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_9</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_9</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_10</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_11</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_11</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_12</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_13</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_13</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_14</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_14</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_15</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_16</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_16</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_17</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_17</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_18</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_18</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_19</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_19</span><span class="si">}</span>
<span class="s2">         translate </span><span class="si">{</span><span class="n">molecule_name_20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_20</span><span class="si">}</span>

<span class="s2">         system = combine </span><span class="si">{</span><span class="n">combine_line</span><span class="si">}</span>
<span class="s2">         unsolved_system = system</span>
<span class="s2">         setBox unsolved_system vdw 0.0</span>
<span class="s2">         saveamberparm unsolved_system </span><span class="si">{</span><span class="n">unsolved_prmtop_filepath</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unsolved_rst_filepath</span><span class="si">}</span>
<span class="s2">         savepdb unsolved_system </span><span class="si">{</span><span class="n">unsolved_two_ten_array_pdb_filepath</span><span class="si">}</span>
<span class="s2">    </span>
<span class="s2">         solvatebox system TIP3PBOX </span><span class="si">{</span><span class="n">buffer</span><span class="si">}</span>

<span class="s2">         saveamberparm system </span><span class="si">{</span><span class="n">prmtop_filepath</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rst_filepath</span><span class="si">}</span>
<span class="s2">         savepdb system </span><span class="si">{</span><span class="n">two_ten_array_pdb_filepath</span><span class="si">}</span>
<span class="s2">         quit</span>
<span class="s2">         &quot;&quot;&quot;</span>
    
         <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
             <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
            
         <span class="n">leap_command</span> <span class="o">=</span> <span class="s2">&quot;tleap -f &quot;</span> <span class="o">+</span> <span class="n">intleap_path</span>
         <span class="c1">#print(&quot;The command that would be run in the shell is: &quot;)</span>
         <span class="c1">#print(leap_command)</span>
         <span class="nb">print</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">)</span>
         <span class="k">try</span><span class="p">:</span>
             <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">leap_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
             <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                 <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="c1"># Command failed, print error message</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="c1"># Exception occurred during subprocess execution</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

         <span class="n">cd_command</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">main_dir</span><span class="p">)</span>
         <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cd_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
         <span class="k">return</span><span class="p">(</span><span class="n">system_name</span><span class="p">,</span> <span class="n">unsolved_system_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.build_2_10_polymer_array_infinite">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.build_2_10_polymer_array_infinite">[docs]</a>
    <span class="k">def</span> <span class="nf">build_2_10_polymer_array_infinite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">molecule_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">number_of_units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Thsis function builds arrays of polymers using the pre generated pdb files</span>
        <span class="k">if</span> <span class="n">number_of_units</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">base_molecule_name</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">molecule_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide 3 arguments as follows: build_2_10_polymer_array(base_molecule_name, polymer_name, number_of_units)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Base polymer name: A string of the polymer name, i.e. &#39;3HB_trimer&#39;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Polymer name: A string of the polymer name, i.e. &#39;3HB_10_polymer&#39;&quot;</span><span class="p">)</span>
            
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>        

        <span class="k">if</span> <span class="n">buffer</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        
         
        <span class="n">pdb_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">load_pdb_filepath</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>
         
        <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">)</span>
        <span class="n">cd_command</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span> <span class="o">+</span> <span class="n">molecule_dir</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cd_command</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current directory:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
             
        <span class="n">mainchain_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>

        <span class="n">file_subtype</span> <span class="o">=</span> <span class="s2">&quot;_2_10_array_infinite&quot;</span> 
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz_dists</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>

        <span class="c1">#translate_distance = int(max(x, y)) + 1 # Removed z as they should not overlap in this distance</span>
        <span class="n">translate_distance</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Removed z as they should not overlap in this distance</span>

        <span class="n">molecule_name_1</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_1&quot;</span>
        <span class="n">molecule_name_2</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_2&quot;</span>
        <span class="n">molecule_name_3</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_3&quot;</span>
        <span class="n">molecule_name_4</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_4&quot;</span>
        <span class="n">molecule_name_5</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_5&quot;</span>
        <span class="n">molecule_name_6</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_6&quot;</span>
        <span class="n">molecule_name_7</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_7&quot;</span>
        <span class="n">molecule_name_8</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_8&quot;</span>
        <span class="n">molecule_name_9</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_9&quot;</span>
        <span class="n">molecule_name_10</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_10&quot;</span>
        <span class="n">molecule_name_11</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_11&quot;</span>
        <span class="n">molecule_name_12</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_12&quot;</span>
        <span class="n">molecule_name_13</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_13&quot;</span>
        <span class="n">molecule_name_14</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_14&quot;</span>
        <span class="n">molecule_name_15</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_15&quot;</span>
        <span class="n">molecule_name_16</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_16&quot;</span>
        <span class="n">molecule_name_17</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_17&quot;</span>
        <span class="n">molecule_name_18</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_18&quot;</span>
        <span class="n">molecule_name_19</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_19&quot;</span>
        <span class="n">molecule_name_20</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="s2">&quot;_20&quot;</span>
         
        <span class="c1"># central 2 polymers on the top line (1,2)</span>
        <span class="n">translate_line_1</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_2</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

        <span class="c1"># central 2 polymers on the bottom line (3,4)</span>
        <span class="n">translate_line_3</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_4</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="c1"># Polymers either side of central 2 polymers on the top line (5,6)</span>
        <span class="n">translate_line_5</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_6</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

        <span class="c1"># Polymers either side of central 2 polymers on the bottom line (7,8)</span>
        <span class="n">translate_line_7</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_8</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="c1"># Polymers (9,10)</span>
        <span class="n">translate_line_9</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_10</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

        <span class="c1"># Polymers (11,12)</span>
        <span class="n">translate_line_11</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_12</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="c1"># Polymers (13,14)</span>
        <span class="n">translate_line_13</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">3.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_14</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">3.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

        <span class="c1"># Polymers (15,16)</span>
        <span class="n">translate_line_15</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">3.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_16</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">3.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="c1"># Polymers (17,18)</span>
        <span class="n">translate_line_17</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">4.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>
        <span class="n">translate_line_18</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">4.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0.0}&quot;</span>

        <span class="c1"># Polymers (19,20)</span>
        <span class="n">translate_line_19</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">4.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="n">translate_line_20</span> <span class="o">=</span> <span class="s2">&quot;{0.0 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">translate_distance</span><span class="o">*</span><span class="mf">4.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">translate_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">combine_line</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">molecule_name_1</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_2</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_3</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_4</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_5</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_6</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_7</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_8</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_9</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_10</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_11</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_12</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_13</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_14</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_15</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_16</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_17</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_18</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_19</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">molecule_name_20</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">base_mol_name</span> <span class="o">=</span> <span class="n">molecule_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intleap_path</span> <span class="o">=</span> <span class="n">base_mol_name</span> <span class="o">+</span> <span class="n">file_subtype</span> <span class="o">+</span> <span class="s2">&quot;.intleap&quot;</span>

        <span class="n">system_name</span> <span class="o">=</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span>
        <span class="n">unsolved_system_name</span> <span class="o">=</span> <span class="s2">&quot;unsolved_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span>
        
        <span class="n">prmtop_filepath</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
        <span class="n">rst_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.rst7&quot;</span><span class="p">)</span>

        <span class="n">unsolved_prmtop_filepath</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;unsolved_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
        <span class="n">unsolved_rst_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;unsolved_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span> <span class="o">+</span> <span class="s2">&quot;.rst7&quot;</span><span class="p">)</span>
        
        <span class="n">two_ten_array_pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
        <span class="n">unsolved_two_ten_array_pdb_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;unsolved_&quot;</span> <span class="o">+</span> <span class="n">molecule_name</span> <span class="o">+</span> <span class="n">file_subtype</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
    
        <span class="n">mainchain_rescode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">retrieve_polymeric_rescodes</span><span class="p">(</span><span class="n">base_molecule_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">poly_string</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">mainchain_rescode</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_units</span><span class="p">)</span>
        <span class="n">poly_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span>

        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;source leaprc.gaff</span>
<span class="s2">        source leaprc.water.fb3</span>
<span class="s2">        source leaprc.protein.ff14SB</span>

<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">mainchain_prepi_filepath</span><span class="si">}</span>

<span class="s2">        list</span>
<span class="s2">            </span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_2</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_3</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_4</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_5</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_6</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_7</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_8</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_9</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_10</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_11</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_12</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_13</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_14</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_15</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_16</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_17</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_18</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_19</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="n">molecule_name_20</span><span class="si">}</span><span class="s2"> = sequence </span><span class="si">{</span><span class="n">poly_string</span><span class="si">}</span>
<span class="s2">         </span>
<span class="s2">        check </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span>
<span class="s2">         </span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_1</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_2</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_3</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_3</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_4</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_4</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_5</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_6</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_6</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_7</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_7</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_8</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_9</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_9</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_10</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_11</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_11</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_12</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_13</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_13</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_14</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_14</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_15</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_16</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_16</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_17</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_17</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_18</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_18</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_19</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_19</span><span class="si">}</span>
<span class="s2">        translate </span><span class="si">{</span><span class="n">molecule_name_20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">translate_line_20</span><span class="si">}</span>

<span class="s2">        system = combine </span><span class="si">{</span><span class="n">combine_line</span><span class="si">}</span>
<span class="s2">        unsolved_system = system</span>
<span class="s2">        setBox unsolved_system vdw 0.0</span>
<span class="s2">        saveamberparm unsolved_system </span><span class="si">{</span><span class="n">unsolved_prmtop_filepath</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unsolved_rst_filepath</span><span class="si">}</span>
<span class="s2">        savepdb unsolved_system </span><span class="si">{</span><span class="n">unsolved_two_ten_array_pdb_filepath</span><span class="si">}</span>

<span class="s2">        quit</span>
<span class="s2">        &quot;&quot;&quot;</span>
    
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
            
        <span class="n">leap_command</span> <span class="o">=</span> <span class="s2">&quot;tleap -f &quot;</span> <span class="o">+</span> <span class="n">intleap_path</span>
        <span class="c1">#print(&quot;The command that would be run in the shell is: &quot;)</span>
        <span class="c1">#print(leap_command)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">leap_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">cd_command</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">main_dir</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cd_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">system_name</span><span class="p">,</span> <span class="n">unsolved_system_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildAmberSystems.solvate_frame_from_sim">
<a class="viewcode-back" href="../sw_build_systems.html#sw_build_systems.BuildAmberSystems.solvate_frame_from_sim">[docs]</a>
    <span class="k">def</span> <span class="nf">solvate_frame_from_sim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">,</span> <span class="n">system_name</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    
        <span class="n">molecule_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">molecules_dir</span><span class="p">,</span> <span class="n">base_molecule_name</span><span class="p">)</span>
        <span class="n">cd_command</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span> <span class="o">+</span> <span class="n">molecule_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">molecule_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    
        <span class="n">mainchain_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;mainchain_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        <span class="n">head_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;head_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        <span class="n">tail_prepi_filepath</span> <span class="o">=</span> <span class="s2">&quot;tail_&quot;</span> <span class="o">+</span> <span class="n">base_molecule_name</span> <span class="o">+</span> <span class="s2">&quot;.prepi&quot;</span>
        
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">systems_dir</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">x_vec</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_vec</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z_vec</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">box_set_line</span> <span class="o">=</span> <span class="s2">&quot;set system box {&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x_vec</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y_vec</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z_vec</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 90.0 90.0 90.0}&quot;</span>

        <span class="n">intleap_path</span> <span class="o">=</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.intleap&quot;</span>
        <span class="n">prmtop_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.prmtop&quot;</span><span class="p">)</span>
        <span class="n">rst_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;rst7&quot;</span><span class="p">)</span>
        <span class="n">solvated_pdb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">system_name</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
    
    
        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;source leaprc.gaff</span>
<span class="s2">        source leaprc.water.fb3</span>
<span class="s2">    </span>
<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">head_prepi_filepath</span><span class="si">}</span>
<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">mainchain_prepi_filepath</span><span class="si">}</span>
<span class="s2">        loadamberprep </span><span class="si">{</span><span class="n">tail_prepi_filepath</span><span class="si">}</span>
<span class="s2">        list</span>
<span class="s2">        system = loadpdb </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span>
<span class="s2">        solvatebox system TIP3PBOX 0.0</span>

<span class="s2">        saveamberparm system </span><span class="si">{</span><span class="n">prmtop_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rst_path</span><span class="si">}</span>
<span class="s2">        savepdb system </span><span class="si">{</span><span class="n">solvated_pdb</span><span class="si">}</span>
<span class="s2">        quit</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intleap_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
            
        <span class="n">leap_command</span> <span class="o">=</span> <span class="s2">&quot;tleap -f &quot;</span> <span class="o">+</span> <span class="n">intleap_path</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">leap_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Command executed successfully</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Command failed, print error message</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Exception occurred during subprocess execution</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">cd_command</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">main_dir</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cd_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">system_name</span><span class="p">)</span></div>
</div>

        
<span class="c1">#class BuildBioOilSystems(BuildSystems):</span>
<span class="c1">#    def __init__:</span>
 <span class="c1">#       pass</span>

    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Daniel J. York.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>